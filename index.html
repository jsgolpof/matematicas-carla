<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escuela Carla - Master Class üéì</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --purple: #A8D8EA;
            --success: #2ecc71;
            --error: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --font-main: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* HEADER & STATS */
        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.95);
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .level-badge {
            background: linear-gradient(135deg, var(--primary), #ff8e8e);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .user-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: var(--dark);
        }

        /* CARDS */
        .card {
            background: white;
            border-radius: 25px;
            padding: 30px;
            width: 100%;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            text-align: center;
            animation: slideUp 0.5s ease;
            box-sizing: border-box;
        }

        @keyframes slideUp { 
            from { transform: translateY(30px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }

        @keyframes popIn { 
            from { transform: scale(0.5); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }

        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.05); } 
            100% { transform: scale(1); } 
        }

        @keyframes celebrate { 
            0% { transform: rotate(0deg); } 
            25% { transform: rotate(-10deg); } 
            75% { transform: rotate(10deg); } 
            100% { transform: rotate(0deg); } 
        }

        h1 { 
            color: var(--dark); 
            margin-top: 0; 
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 { color: var(--secondary); margin: 10px 0; }
        h3 { color: var(--dark); margin: 15px 0; }

        /* BUTTONS */
        button {
            background: white;
            border: 3px solid var(--secondary);
            color: var(--dark);
            padding: 15px 20px;
            width: 100%;
            margin: 8px 0;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-main);
            box-shadow: 0 5px 0 #16a085;
        }
        button:active { transform: translateY(5px); box-shadow: none; }
        button.primary { 
            background: linear-gradient(135deg, var(--primary), #ff8e8e); 
            color: white; 
            border-color: #c0392b; 
            box-shadow: 0 5px 0 #c0392b; 
        }
        button.secondary { 
            background: linear-gradient(135deg, var(--secondary), #6ee7db); 
            color: white; 
            border-color: #16a085; 
            box-shadow: 0 5px 0 #16a085; 
        }
        button.accent {
            background: linear-gradient(135deg, var(--accent), #fff3b0);
            color: var(--dark);
            border-color: #f1c40f;
            box-shadow: 0 5px 0 #f1c40f;
        }
        button.logout {
            background: #95a5a6;
            color: white;
            border: none;
            box-shadow: 0 5px 0 #7f8c8d;
            margin-top: 15px;
        }
        
        /* LOGIN SCREEN */
        .emoji-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .emoji-option {
            font-size: 2.5rem;
            padding: 10px;
            border-radius: 15px;
            border: 3px solid #ddd;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
        }
        .emoji-option:hover { transform: scale(1.1); }
        .emoji-option.selected {
            border-color: var(--primary);
            background: #ffe0e0;
            animation: pulse 0.3s;
        }
        .emoji-preview {
            font-size: 3rem;
            margin: 15px 0;
            min-height: 60px;
        }
        .login-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3rem;
            text-align: center;
            border: 3px solid var(--secondary);
            border-radius: 15px;
            margin: 10px 0;
            font-family: var(--font-main);
        }

        /* GAME SPECIFIC */
        .question-area { 
            font-size: 1.5rem; 
            margin: 20px 0; 
            line-height: 1.6; 
            font-weight: 600;
            color: var(--dark);
        }
        .question-context {
            background: linear-gradient(135deg, #e8f6f3, #f0f9ff);
            border-left: 5px solid var(--secondary);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
            font-size: 1.2rem;
        }
        .options-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 20px; 
        }
        
        .option-btn {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 3px solid #ddd;
            box-shadow: 0 5px 0 #ccc;
            font-size: 1.1rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .option-btn:hover { background: #e9ecef; }
        
        .option-btn.correct {
            background: linear-gradient(135deg, var(--success), #58d68d) !important;
            color: white !important;
            border-color: #27ae60 !important;
            box-shadow: 0 5px 0 #219150 !important;
            animation: celebrate 0.5s;
        }
        .option-btn.wrong {
            background: linear-gradient(135deg, var(--error), #ec7063) !important;
            color: white !important;
            border-color: #c0392b !important;
            box-shadow: 0 5px 0 #c0392b !important;
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* FEEDBACK MODAL */
        .feedback-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        .feedback-card {
            background: white;
            padding: 30px;
            border-radius: 25px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .feedback-title { 
            font-size: 2.5rem; 
            margin: 0 0 15px 0; 
            font-weight: 900;
            background: linear-gradient(135deg, var(--success), #58d68d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .feedback-explanation { 
            background: linear-gradient(135deg, #e8f6f3, #f0f9ff); 
            border-left: 5px solid var(--secondary); 
            padding: 20px; 
            text-align: left; 
            margin: 20px 0; 
            border-radius: 10px;
            font-size: 1.2rem;
            line-height: 1.5;
        }
        .feedback-icon { 
            font-size: 5rem; 
            display: block; 
            margin-bottom: 10px;
            animation: celebrate 1s infinite;
        }

        /* INPUTS */
        input[type="number"], input[type="text"] {
            width: 90%;
            padding: 18px;
            font-size: 1.8rem;
            text-align: center;
            border: 3px solid var(--secondary);
            border-radius: 15px;
            margin: 10px 0;
            font-family: var(--font-main);
        }

        /* SCREENS */
        .screen { display: none; width: 100%; }
        .active { display: block; }

        .progress-container {
            width: 100%;
            background: #eee;
            height: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            width: 0%;
            transition: width 0.5s;
        }

        /* MEDALS */
        .medal-grid { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 15px;
            margin: 20px 0;
        }
        .medal-item { 
            text-align: center; 
            width: 90px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        .medal-icon { 
            font-size: 3.5rem; 
            filter: grayscale(100%); 
            opacity: 0.3; 
            transition: 0.5s;
        }
        .medal-item.unlocked .medal-icon { 
            filter: grayscale(0%); 
            opacity: 1; 
            transform: scale(1.1);
            animation: celebrate 0.5s;
        }
        .medal-name { 
            font-size: 0.85rem; 
            font-weight: bold; 
            margin-top: 5px;
            color: var(--dark);
        }

        /* STATS BOX */
        .stats-box {
            background: linear-gradient(135deg, var(--purple), #e8f6f3);
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            font-size: 1.1rem;
        }

        /* CONFETTI */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--accent);
            animation: fall 3s linear forwards;
            z-index: 999;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- PANTALLA 0: LOGIN -->
    <div id="screen-login" class="screen active">
        <div class="card">
            <h1>üéì Escuela Master Class</h1>
            <p style="font-size: 1.2rem; color: #666;">¬°Bienvenido! ¬øEres nuevo o ya tienes usuario?</p>
            
            <button class="primary" onclick="showScreen('screen-login-existing')">üîë Ya tengo usuario</button>
            <button class="secondary" onclick="showScreen('screen-login-new')">üÜï Soy nuevo</button>
        </div>
    </div>

    <!-- PANTALLA 1: LOGIN EXISTENTE -->
    <div id="screen-login-existing" class="screen">
        <div class="card">
            <h2>üîë Iniciar Sesi√≥n</h2>
            <input type="text" id="login-name" class="login-input" placeholder="Tu nombre (ej: Carla)">
            <p>Selecciona tus 3 emojis secretos (en orden):</p>
            <div class="emoji-preview" id="login-emoji-preview"></div>
            <div class="emoji-selector" id="login-emoji-selector"></div>
            <button class="primary" onclick="loginUser()">Entrar üöÄ</button>
            <button class="logout" onclick="showScreen('screen-login')">‚Üê Volver</button>
        </div>
    </div>

    <!-- PANTALLA 2: LOGIN NUEVO -->
    <div id="screen-login-new" class="screen">
        <div class="card">
            <h2>üÜï Crear Usuario</h2>
            <input type="text" id="new-name" class="login-input" placeholder="Tu nombre (ej: Carla)">
            <p>Elige tus 3 emojis secretos (en orden):</p>
            <div class="emoji-preview" id="new-emoji-preview"></div>
            <div class="emoji-selector" id="new-emoji-selector"></div>
            <button class="primary" onclick="createUser()">¬°Crear mi cuenta! üéâ</button>
            <button class="logout" onclick="showScreen('screen-login')">‚Üê Volver</button>
        </div>
    </div>

    <!-- PANTALLA 3: INICIO -->
    <div id="screen-home" class="screen">
        <div class="header">
            <div class="user-display">
                <span id="header-emojis"></span>
                <span id="header-name"></span>
            </div>
            <div class="level-badge">‚≠ê <span id="total-stars">0</span></div>
            <div style="font-size:1.5rem; cursor:pointer;" onclick="showScreen('screen-settings')">‚öôÔ∏è</div>
        </div>

        <div class="card">
            <h1 id="welcome-title">¬°Hola!</h1>
            <div style="font-size: 5rem; margin: 20px; animation: celebrate 2s infinite;">üöÄ</div>
            
            <div class="stats-box">
                <div>üìö Preguntas √∫nicas: <strong id="unique-questions">0</strong></div>
                <div>üèÜ Nivel: <strong id="user-level">1</strong></div>
            </div>

            <button class="primary" onclick="showScreen('screen-subjects')">üìö Empezar a Aprender</button>
            <button class="secondary" onclick="showScreen('screen-rewards')">üèÖ Mis Medallas</button>
            <button class="accent" onclick="logoutUser()">üö™ Cerrar Sesi√≥n</button>
        </div>
    </div>

    <!-- PANTALLA 4: ASIGNATURAS -->
    <div id="screen-subjects" class="screen">
        <div class="header">
            <div style="font-size:1.5rem; cursor:pointer;" onclick="showScreen('screen-home')">üè†</div>
            <div class="level-badge">‚≠ê <span id="subject-stars">0</span></div>
            <div></div>
        </div>
        <div class="card">
            <h2>¬øQu√© quieres aprender hoy?</h2>
            <button onclick="selectSubject('mates')" style="background:linear-gradient(135deg, #FF9F43, #f39c12); color:white; border:none;">üßÆ Matem√°ticas</button>
            <button onclick="selectSubject('lengua')" style="background:linear-gradient(135deg, #54a0ff, #2e86de); color:white; border:none;">üìñ Lengua Castellana</button>
            <button onclick="selectSubject('medio')" style="background:linear-gradient(135deg, #1dd1a1, #10ac84); color:white; border:none;">üåç Conocimiento del Medio</button>
        </div>
    </div>

    <!-- PANTALLA 5: TEMAS -->
    <div id="screen-topics" class="screen">
        <div class="header">
            <div style="font-size:1.5rem; cursor:pointer;" onclick="showScreen('screen-subjects')">üè†</div>
            <div class="level-badge">‚≠ê <span id="topic-stars">0</span></div>
            <div></div>
        </div>
        <div class="card">
            <h2 id="topic-title">Temas</h2>
            <div id="topics-list"></div>
        </div>
    </div>

    <!-- PANTALLA 6: JUEGO -->
    <div id="screen-game" class="screen">
        <div class="header">
            <div style="font-size:1.5rem; cursor:pointer;" onclick="showScreen('screen-topics')">üè†</div>
            <div class="level-badge">‚≠ê <span id="game-stars">0</span></div>
            <div style="font-size:1.2rem;">üîä <span id="voice-status">ON</span></div>
        </div>
        
        <div class="progress-container"><div class="progress-bar" id="game-progress"></div></div>
        
        <div class="card">
            <div id="question-emoji" style="font-size: 4rem; margin-bottom: 10px; animation: celebrate 2s infinite;">‚ùì</div>
            <div id="question-context" class="question-context"></div>
            <div id="question-text" class="question-area">Pregunta...</div>
            
            <div id="input-area"></div>
            <div id="options-area" class="options-grid"></div>
            
            <button id="btn-submit" class="primary" onclick="checkInputAnswer()" style="margin-top:20px; display:none;">‚úÖ Comprobar</button>
        </div>
    </div>

    <!-- PANTALLA 7: RECOMPENSAS -->
    <div id="screen-rewards" class="screen">
        <div class="header">
            <div style="font-size:1.5rem; cursor:pointer;" onclick="showScreen('screen-home')">üè†</div>
            <div class="level-badge">‚≠ê <span id="rewards-stars">0</span></div>
            <div></div>
        </div>
        <div class="card">
            <h2>üèÜ Tu Muro de la Fama</h2>
            <div class="stats-box">
                <div>üìö Preguntas √∫nicas: <strong id="reward-unique">0</strong></div>
                <div>‚≠ê Estrellas totales: <strong id="reward-stars">0</strong></div>
                <div>üèÜ Nivel: <strong id="reward-level">1</strong></div>
            </div>
            <div class="medal-grid">
                <div class="medal-item" id="medal-1"><div class="medal-icon">ü•â</div><div class="medal-name">Bronce</div></div>
                <div class="medal-item" id="medal-2"><div class="medal-icon">ü•à</div><div class="medal-name">Plata</div></div>
                <div class="medal-item" id="medal-3"><div class="medal-icon">ü•á</div><div class="medal-name">Oro</div></div>
                <div class="medal-item" id="medal-4"><div class="medal-icon">üëë</div><div class="medal-name">Reina</div></div>
                <div class="medal-item" id="medal-5"><div class="medal-icon">üöÄ</div><div class="medal-name">Astronauta</div></div>
                <div class="medal-item" id="medal-6"><div class="medal-icon">ü¶Ñ</div><div class="medal-name">M√°gica</div></div>
                <div class="medal-item" id="medal-7"><div class="medal-icon">üåü</div><div class="medal-name">Estelar</div></div>
                <div class="medal-item" id="medal-8"><div class="medal-icon">üíé</div><div class="medal-name">Diamante</div></div>
            </div>
        </div>
    </div>

    <!-- PANTALLA 8: AJUSTES -->
    <div id="screen-settings" class="screen">
        <div class="header">
            <div style="font-size:1.5rem; cursor:pointer;" onclick="showScreen('screen-home')">üè†</div>
            <div class="level-badge">‚öôÔ∏è Ajustes</div>
            <div></div>
        </div>
        <div class="card">
            <h2>‚öôÔ∏è Configuraci√≥n</h2>
            <button class="secondary" onclick="toggleVoice()">üîä Voz: <span id="settings-voice">ON</span></button>
            <button class="accent" onclick="resetUserProgress()">üîÑ Borrar MI Progreso</button>
            <button style="background:linear-gradient(135deg, #e74c3c, #c0392b); color:white; border:none;" onclick="deleteAllUsers()">‚ö†Ô∏è Borrar TODOS los Usuarios</button>
            <button class="logout" onclick="showScreen('screen-home')">‚Üê Volver</button>
        </div>
    </div>

</div>

<!-- MODAL DE FEEDBACK -->
<div id="feedback-modal" class="feedback-overlay">
    <div class="feedback-card">
        <span id="fb-icon" class="feedback-icon">üéâ</span>
        <h2 id="fb-title" class="feedback-title">¬°Correcto!</h2>
        <div id="fb-content"></div>
        <button class="primary" onclick="nextQuestion()" style="margin-top:20px;">Siguiente ‚û°Ô∏è</button>
    </div>
</div>

<script>
/* ============================================================================
   CONFIGURACI√ìN Y ESTADO GLOBAL
   ============================================================================ */

const EMOJI_OPTIONS = ['ü¶Ñ','üåà','‚≠ê','üéà','üçï','üê±','üöÄ','üå∏','üéÆ','üç¶'];

let appState = {
    currentUser: null,
    voiceEnabled: true,
    selectedEmojis: []
};

let gameState = {
    subject: '',
    topic: '',
    currentQ: null,
    sessionStars: 0,
    attempts: 0,
    streak: 0
};

/* ============================================================================
   BASE DE DATOS MASIVA DE PREGUNTAS
   ============================================================================ */

const questionBank = {
    lengua: {
        ortografia: [
            { id: 'ort_1', q: '¬øC√≥mo se escribe: __arco?', context: 'Un barco navega por el mar.', options: ['B', 'V'], correct: 'B', explanation: 'Se escribe con <b>B</b> porque las palabras que empiezan por "bar-" suelen llevar B (barco, barba, barrio, barniz).' },
            { id: 'ort_2', q: '¬øC√≥mo se escribe: __aca?', context: 'La vaca da leche en la granja.', options: ['B', 'V'], correct: 'V', explanation: 'Se escribe con <b>V</b>. Truco: "La Vaca tiene cuernos en forma de V".' },
            { id: 'ort_3', q: '¬øC√≥mo se escribe: __urro?', context: 'El burro es un animal muy trabajador.', options: ['B', 'V'], correct: 'B', explanation: 'Se escribe con <b>B</b>. Las palabras que empiezan por "bur-" llevan B (burro, burro, burbuja).' },
            { id: 'ort_4', q: '¬øC√≥mo se escribe: __entana?', context: 'Abre la ventana para que entre aire.', options: ['B', 'V'], correct: 'V', explanation: 'Se escribe con <b>V</b>. Las palabras que empiezan por "ven-" suelen llevar V (ventana, viento, vender).' },
            { id: 'ort_5', q: '¬øC√≥mo se escribe: __eb√©?', context: 'El beb√© llora cuando tiene hambre.', options: ['B', 'V'], correct: 'B', explanation: 'Se escribe con <b>B</b>. Las palabras que empiezan por "be-" y "bi-" llevan B (beb√©, beber, bicicleta).' },
            { id: 'ort_6', q: '¬øC√≥mo se escribe: __olc√°n?', context: 'El volc√°n echa lava y humo.', options: ['B', 'V'], correct: 'V', explanation: 'Se escribe con <b>V</b>. Las palabras que empiezan por "vol-" llevan V (volc√°n, volver, volumen).' },
            { id: 'ort_7', q: '¬øQu√© palabra est√° bien escrita?', context: 'Este animal tiene el cuello muy largo.', options: ['Girafa', 'Jirafa'], correct: 'Jirafa', explanation: 'Se escribe con <b>J</b>. Las palabras que empiezan por "jira-" llevan J.' },
            { id: 'ort_8', q: '¬øQu√© palabra est√° bien escrita?', context: 'El ___ ma√∫lla y caza ratones.', options: ['Gato', 'Jato'], correct: 'Gato', explanation: 'Se escribe con <b>G</b>. Los sonidos "ga, go, gu" suelen ir con G.' },
            { id: 'ort_9', q: '¬øQu√© palabra est√° bien escrita?', context: 'Las ___ son frutas amarillas y curvas.', options: ['Guinanas', 'Bananas'], correct: 'Bananas', explanation: 'Se escribe con <b>B</b>. "Banana" viene del √°rabe y siempre lleva B.' },
            { id: 'ort_10', q: '¬øLleva H la palabra "__uevo"?', context: 'El huevo es blanco y tiene gallina dentro.', options: ['S√≠, lleva H', 'No, no lleva H'], correct: 'S√≠, lleva H', explanation: '¬°S√≠! Las palabras que empiezan por "hue-" y "hie-" SIEMPRE llevan H muda (huevo, hielo, hierba, hueso).' },
            { id: 'ort_11', q: '¬øLleva H la palabra "__ielo"?', context: 'El hielo es agua congelada.', options: ['S√≠, lleva H', 'No, no lleva H'], correct: 'S√≠, lleva H', explanation: '¬°S√≠! "Hielo" empieza por "hie-", por eso lleva H muda.' },
            { id: 'ort_12', q: '¬øLleva H la palabra "__ombre"?', context: 'El ser humano es un...', options: ['S√≠, lleva H', 'No, no lleva H'], correct: 'S√≠, lleva H', explanation: 'S√≠, "hombre" lleva H inicial. Viene del lat√≠n "homo".' },
            { id: 'ort_13', q: '¬øC√≥mo se pluraliza "L√°piz"?', context: 'Tengo un l√°piz, tengo varios...', options: ['L√°pizes', 'L√°pices'], correct: 'L√°pices', explanation: 'Las palabras terminadas en -Z cambian la Z por C en plural (L√°piz‚ÜíL√°pices, Pez‚ÜíPeces, Luz‚ÜíLuces).' },
            { id: 'ort_14', q: '¬øC√≥mo se pluraliza "Pez"?', context: 'Un pez, muchos...', options: ['Pezes', 'Peces'], correct: 'Peces', explanation: 'Las palabras terminadas en -Z cambian la Z por C en plural.' },
            { id: 'ort_15', q: '¬øC√≥mo se pluraliza "Voz"?', context: 'Una voz, muchas...', options: ['Vozes', 'Voces'], correct: 'Voces', explanation: 'Las palabras terminadas en -Z cambian la Z por C en plural.' },
            { id: 'ort_16', q: 'Elige la palabra correcta:', context: 'Voy a ___ agua.', options: ['Hechar', 'Echar'], correct: 'Echar', explanation: '"Echar" (tirar, poner) se escribe SIN H. "Hechar" no existe.' },
            { id: 'ort_17', q: 'Elige la palabra correcta:', context: 'Lo ___ hecho bien.', options: ['He', 'E'], correct: 'He', explanation: '"He" del verbo haber lleva H. "E" es la letra del abecedario.' },
            { id: 'ort_18', q: '¬øQu√© palabra lleva H?', context: 'Una de estas lleva H.', options: ['Oso', 'Hueso'], correct: 'Hueso', explanation: '"Hueso" lleva H porque empieza por "hue-". "Oso" no lleva H.' },
            { id: 'ort_19', q: '¬øQu√© palabra lleva H?', context: 'Una de estas lleva H.', options: ['Ola', 'Hola'], correct: 'Hola', explanation: '"Hola" (saludo) lleva H. "Ola" (del mar) no lleva H.' },
            { id: 'ort_20', q: 'Completa: "__ormiga"', context: 'La ___ es muy peque√±a y trabajadora.', options: ['H', 'Sin H'], correct: 'H', explanation: '"Hormiga" lleva H inicial.' }
        ],
        gramatica: [
            { id: 'gra_1', q: '¬øQu√© tipo de palabra es "correr"?', context: 'Me gusta correr en el parque.', options: ['Sustantivo', 'Verbo', 'Adjetivo'], correct: 'Verbo', explanation: 'Es un <b>verbo</b> porque indica una ACCI√ìN. Los verbos son lo que hacemos (correr, saltar, comer).' },
            { id: 'gra_2', q: '¬øQu√© tipo de palabra es "casa"?', context: 'Mi casa es muy grande.', options: ['Sustantivo', 'Verbo', 'Adjetivo'], correct: 'Sustantivo', explanation: 'Es un <b>sustantivo</b> porque nombra un OBJETO o LUGAR. Los sustantivos son personas, animales o cosas.' },
            { id: 'gra_3', q: '¬øQu√© tipo de palabra es "rojo"?', context: 'El coche es rojo.', options: ['Sustantivo', 'Verbo', 'Adjetivo'], correct: 'Adjetivo', explanation: 'Es un <b>adjetivo</b> porque dice C√ìMO ES algo. Los adjetivos dan cualidades (rojo, grande, bonito).' },
            { id: 'gra_4', q: '¬øCu√°l es el sustantivo? "El perro ladra"', context: 'Encuentra el nombre en la frase.', options: ['El', 'Perro', 'Ladra'], correct: 'Perro', explanation: '"Perro" es el sustantivo porque nombra al animal. "El" es el art√≠culo y "ladra" es el verbo.' },
            { id: 'gra_5', q: '¬øCu√°l es el adjetivo? "La casa roja"', context: 'Encuentra la cualidad en la frase.', options: ['Casa', 'La', 'Roja'], correct: 'Roja', explanation: '"Roja" es el adjetivo porque nos dice C√ìMO es la casa.' },
            { id: 'gra_6', q: '¬øQu√© tiempo verbal es "com√≠"?', context: 'Ayer com√≠ pizza.', options: ['Presente', 'Pasado', 'Futuro'], correct: 'Pasado', explanation: '"Com√≠" es PASADO porque la acci√≥n YA termin√≥. Lo sabemos por el acento y porque dice "ayer".' },
            { id: 'gra_7', q: '¬øQu√© tiempo verbal es "comer√©"?', context: 'Ma√±ana comer√© ensalada.', options: ['Presente', 'Pasado', 'Futuro'], correct: 'Futuro', explanation: '"Comer√©" es FUTURO porque la acci√≥n TODAV√çA NO ha pasado. Lo sabemos por la terminaci√≥n "-√©".' },
            { id: 'gra_8', q: '¬øQu√© tiempo verbal es "como"?', context: 'Yo como fruta todos los d√≠as.', options: ['Presente', 'Pasado', 'Futuro'], correct: 'Presente', explanation: '"Como" es PRESENTE porque es algo que hago AHORA o habitualmente.' },
            { id: 'gra_9', q: '¬øCu√°l es el verbo? "Los ni√±os juegan"', context: 'Encuentra la acci√≥n.', options: ['Los', 'Ni√±os', 'Juegan'], correct: 'Juegan', explanation: '"Juegan" es el verbo porque es la ACCI√ìN que hacen los ni√±os.' },
            { id: 'gra_10', q: '¬ø"Feliz" es un adjetivo?', context: 'Estoy muy feliz hoy.', options: ['S√≠', 'No'], correct: 'S√≠', explanation: 'S√≠, "feliz" es un adjetivo porque dice C√ìMO est√° alguien (una cualidad o estado).' }
        ],
        sinonimos: [
            { id: 'sin_1', q: 'Sin√≥nimo de "feliz"', context: 'Busca una palabra que signifique lo mismo.', options: ['Triste', 'Contento', 'Enfadado'], correct: 'Contento', explanation: '"Contento" es sin√≥nimo de "feliz" porque ambas significan tener alegr√≠a.' },
            { id: 'sin_2', q: 'Sin√≥nimo de "triste"', context: 'Busca una palabra que signifique lo mismo.', options: ['Alegre', 'Apenado', 'Feliz'], correct: 'Apenado', explanation: '"Apenado" es sin√≥nimo de "triste" porque ambas significan tener pena.' },
            { id: 'sin_3', q: 'Sin√≥nimo de "grande"', context: 'Busca una palabra que signifique lo mismo.', options: ['Peque√±o', 'Enorme', 'Bajo'], correct: 'Enorme', explanation: '"Enorme" es sin√≥nimo de "grande" porque ambas indican mucho tama√±o.' },
            { id: 'sin_4', q: 'Sin√≥nimo de "r√°pido"', context: 'Busca una palabra que signifique lo mismo.', options: ['Lento', 'Veloz', 'Despacio'], correct: 'Veloz', explanation: '"Veloz" es sin√≥nimo de "r√°pido" porque ambas indican mucha velocidad.' },
            { id: 'sin_5', q: 'Sin√≥nimo de "empezar"', context: 'Busca una palabra que signifique lo mismo.', options: ['Terminar', 'Comenzar', 'Parar'], correct: 'Comenzar', explanation: '"Comenzar" es sin√≥nimo de "empezar" porque ambas significan iniciar algo.' },
            { id: 'sin_6', q: 'Sin√≥nimo de "bonito"', context: 'Busca una palabra que signifique lo mismo.', options: ['Feo', 'Hermoso', 'Regular'], correct: 'Hermoso', explanation: '"Hermoso" es sin√≥nimo de "bonito" porque ambas indican belleza.' },
            { id: 'sin_7', q: 'Sin√≥nimo de "casa"', context: 'Busca una palabra que signifique lo mismo.', options: ['Calle', 'Vivienda', 'Puerta'], correct: 'Vivienda', explanation: '"Vivienda" es sin√≥nimo de "casa" porque ambas son lugares donde vivimos.' },
            { id: 'sin_8', q: 'Sin√≥nimo de "coche"', context: 'Busca una palabra que signifique lo mismo.', options: ['Bicicleta', 'Autom√≥vil', 'Cami√≥n'], correct: 'Autom√≥vil', explanation: '"Autom√≥vil" es sin√≥nimo de "coche" porque ambos son veh√≠culos de cuatro ruedas.' },
            { id: 'sin_9', q: 'Sin√≥nimo de "ni√±o"', context: 'Busca una palabra que signifique lo mismo.', options: ['Adulto', 'Chico', 'Beb√©'], correct: 'Chico', explanation: '"Chico" es sin√≥nimo de "ni√±o" porque ambos se refieren a una persona joven.' },
            { id: 'sin_10', q: 'Sin√≥nimo de "listo"', context: 'Busca una palabra que signifique lo mismo.', options: ['Tonto', 'Inteligente', 'Lento'], correct: 'Inteligente', explanation: '"Inteligente" es sin√≥nimo de "listo" porque ambas indican capacidad mental.' }
        ],
        antonimos: [
            { id: 'ant_1', q: 'Ant√≥nimo de "d√≠a"', context: 'Busca la palabra contraria.', options: ['Sol', 'Noche', 'Luz'], correct: 'Noche', explanation: '"Noche" es ant√≥nimo de "d√≠a" porque son momentos opuestos del tiempo.' },
            { id: 'ant_2', q: 'Ant√≥nimo de "grande"', context: 'Busca la palabra contraria.', options: ['Enorme', 'Peque√±o', 'Alto'], correct: 'Peque√±o', explanation: '"Peque√±o" es ant√≥nimo de "grande" porque son tama√±os opuestos.' },
            { id: 'ant_3', q: 'Ant√≥nimo de "r√°pido"', context: 'Busca la palabra contraria.', options: ['Veloz', 'Lento', 'Correr'], correct: 'Lento', explanation: '"Lento" es ant√≥nimo de "r√°pido" porque son velocidades opuestas.' },
            { id: 'ant_4', q: 'Ant√≥nimo de "alto"', context: 'Busca la palabra contraria.', options: ['Grande', 'Bajo', 'Largo'], correct: 'Bajo', explanation: '"Bajo" es ant√≥nimo de "alto" porque son alturas opuestas.' },
            { id: 'ant_5', q: 'Ant√≥nimo de "bueno"', context: 'Busca la palabra contraria.', options: ['Malo', 'Regular', 'Mejor'], correct: 'Malo', explanation: '"Malo" es ant√≥nimo de "bueno" porque son calidades opuestas.' },
            { id: 'ant_6', q: 'Ant√≥nimo de "caliente"', context: 'Busca la palabra contraria.', options: ['Fuego', 'Fr√≠o', 'Tibio'], correct: 'Fr√≠o', explanation: '"Fr√≠o" es ant√≥nimo de "caliente" porque son temperaturas opuestas.' },
            { id: 'ant_7', q: 'Ant√≥nimo de "abierto"', context: 'Busca la palabra contraria.', options: ['Puerta', 'Cerrado', 'Grande'], correct: 'Cerrado', explanation: '"Cerrado" es ant√≥nimo de "abierto" porque son estados opuestos.' },
            { id: 'ant_8', q: 'Ant√≥nimo de "lleno"', context: 'Busca la palabra contraria.', options: ['Vac√≠o', 'Completo', 'Medio'], correct: 'Vac√≠o', explanation: '"Vac√≠o" es ant√≥nimo de "lleno" porque son cantidades opuestas.' },
            { id: 'ant_9', q: 'Ant√≥nimo de "nuevo"', context: 'Busca la palabra contraria.', options: ['Moderno', 'Viejo', 'Joven'], correct: 'Viejo', explanation: '"Viejo" es ant√≥nimo de "nuevo" porque son edades opuestas.' },
            { id: 'ant_10', q: 'Ant√≥nimo de "blanco"', context: 'Busca la palabra contraria.', options: ['Gris', 'Negro', 'Claro'], correct: 'Negro', explanation: '"Negro" es ant√≥nimo de "blanco" porque son colores opuestos.' }
        ]
    },
    medio: {
        animales: [
            { id: 'ani_1', q: '¬øQu√© tipo de animal es la ballena?', context: 'Vive en el oc√©ano y es enorme.', options: ['Pez', 'Mam√≠fero', 'Reptil'], correct: 'Mam√≠fero', explanation: 'La ballena es MAM√çFERO porque: 1) Respira por pulmones, 2) Tiene sangre caliente, 3) Da de mamar a sus cr√≠as. ¬°Aunque viva en el agua!' },
            { id: 'ani_2', q: '¬øQu√© animal es un invertebrado?', context: 'No tiene huesos internos.', options: ['Perro', 'Mariposa', '√Åguila'], correct: 'Mariposa', explanation: 'La mariposa es INVERTEBRADO porque no tiene columna vertebral. Es un insecto con esqueleto externo.' },
            { id: 'ani_3', q: '¬øQu√© comen los herb√≠voros?', context: 'Son animales como la vaca.', options: ['Carne', 'Plantas', 'Todo'], correct: 'Plantas', explanation: 'Los HERB√çVOROS comen PLANTAS. "Herbi" viene de hierba. Ejemplos: vaca, oveja, conejo.' },
            { id: 'ani_4', q: '¬øQu√© comen los carn√≠voros?', context: 'Son animales como el le√≥n.', options: ['Plantas', 'Carne', 'Frutas'], correct: 'Carne', explanation: 'Los CARN√çVOROS comen CARNE. "Carni" viene de carne. Ejemplos: le√≥n, tigre, lobo.' },
            { id: 'ani_5', q: '¬øC√≥mo respiran los peces?', context: 'Viven bajo el agua.', options: ['Por pulmones', 'Por branquias', 'Por la piel'], correct: 'Por branquias', explanation: 'Los peces respiran por BRANQUIAS, que filtran el ox√≠geno del agua. Por eso no pueden vivir fuera del agua.' },
            { id: 'ani_6', q: '¬øQu√© animal es ov√≠paro?', context: 'Nace de un huevo.', options: ['Gato', 'Gallina', 'Vaca'], correct: 'Gallina', explanation: 'La gallina es OV√çPARA porque pone HUEVOS. "Ovi" viene de huevo. Otros: pato, pez, mariposa.' },
            { id: 'ani_7', q: '¬øQu√© animal es viv√≠paro?', context: 'Nace directamente de la madre.', options: ['Gallina', 'Perro', 'Tortuga'], correct: 'Perro', explanation: 'El perro es VIV√çPARO porque nace directamente del vientre de su madre. "Vivi" viene de vida.' },
            { id: 'ani_8', q: '¬øCu√°ntas patas tiene un insecto?', context: 'Como la hormiga o la abeja.', options: ['4 patas', '6 patas', '8 patas'], correct: '6 patas', explanation: 'Todos los INSECTOS tienen 6 PATAS. Es su caracter√≠stica principal. Ejemplos: hormiga, abeja, mariposa.' },
            { id: 'ani_9', q: '¬øQu√© animal tiene plumas?', context: 'Puede volar por el cielo.', options: ['Murci√©lago', 'Ave', 'Mariposa'], correct: 'Ave', explanation: 'Las AVES tienen PLUMAS. Es lo que las diferencia de otros animales. Ejemplos: √°guila, gorri√≥n, ping√ºino.' },
            { id: 'ani_10', q: '¬øQu√© animal tiene escamas?', context: 'Vive en el agua o en tierra.', options: ['Pez o Reptil', 'Mam√≠fero', 'Ave'], correct: 'Pez o Reptil', explanation: 'Los PECES y REPTILES tienen ESCAMAS que protegen su cuerpo. Ejemplos: pez, serpiente, cocodrilo.' }
        ],
        cuerpo: [
            { id: 'cue_1', q: '¬øQu√© √≥rgano bombea la sangre?', context: 'Funciona como una bomba.', options: ['Cerebro', 'Coraz√≥n', 'Est√≥mago'], correct: 'Coraz√≥n', explanation: 'El CORAZ√ìN bombea sangre a todo el cuerpo. Late unas 100.000 veces al d√≠a. ¬°Es un m√∫sculo muy trabajador!' },
            { id: 'cue_2', q: '¬øD√≥nde se digiere la comida?', context: 'Es como una batidora.', options: ['En el Est√≥mago', 'En el Cerebro', 'En los Pulmones'], correct: 'En el Est√≥mago', explanation: 'El EST√ìMAGO digiere la comida mezcl√°ndola con jugos g√°stricos. Luego pasa al intestino.' },
            { id: 'cue_3', q: '¬øQu√© hueso protege el cerebro?', context: 'Es como un casco natural.', options: ['Las Costillas', 'El Cr√°neo', 'La Pelvis'], correct: 'El Cr√°neo', explanation: 'El CR√ÅNEO protege el cerebro. Es un hueso muy duro en forma de casco.' },
            { id: 'cue_4', q: '¬øQu√© √≥rganos nos permiten respirar?', context: 'Tomamos aire por ellos.', options: ['Coraz√≥n', 'Pulmones', 'Ri√±ones'], correct: 'Pulmones', explanation: 'Los PULMONES toman ox√≠geno del aire y expulsan di√≥xido de carbono. Tenemos dos.' },
            { id: 'cue_5', q: '¬øQu√© √≥rgano controla el pensamiento?', context: 'Es el jefe del cuerpo.', options: ['Coraz√≥n', 'Cerebro', 'H√≠gado'], correct: 'Cerebro', explanation: 'El CEREBRO controla TODO: pensar, moverse, recordar. Es el √≥rgano m√°s importante.' },
            { id: 'cue_6', q: '¬øCu√°ntos huesos tiene el cuerpo humano?', context: 'Un adulto.', options: ['106', '206', '306'], correct: '206', explanation: 'Un adulto tiene 206 HUESOS. ¬°Los beb√©s tienen m√°s (300) pero algunos se unen al crecer!' },
            { id: 'cue_7', q: '¬øQu√© protege las costillas?', context: 'Est√°n en el pecho.', options: ['El cerebro', 'El coraz√≥n y pulmones', 'El est√≥mago'], correct: 'El coraz√≥n y pulmones', explanation: 'Las COSTILLAS protegen el coraz√≥n y los pulmones. Son como una jaula protectora.' },
            { id: 'cue_8', q: '¬øQu√© √≥rgano filtra la sangre?', context: 'Tenemos dos.', options: ['Pulmones', 'Ri√±ones', 'H√≠gado'], correct: 'Ri√±ones', explanation: 'Los RI√ëONES filtran la sangre y producen orina. Tenemos dos, uno a cada lado.' },
            { id: 'cue_9', q: '¬øCu√°l es el hueso m√°s largo?', context: 'Est√° en la pierna.', options: ['F√©mur', 'Brazo', 'Columna'], correct: 'F√©mur', explanation: 'El F√âMUR (en el muslo) es el hueso m√°s largo y fuerte del cuerpo.' },
            { id: 'cue_10', q: '¬øQu√© nos permite saborear la comida?', context: 'Est√° en la boca.', options: ['Los dientes', 'La lengua', 'Los labios'], correct: 'La lengua', explanation: 'La LENGUA tiene papilas gustativas que detectan sabores: dulce, salado, √°cido y amargo.' }
        ],
        planeta: [
            { id: 'pla_1', q: '¬øCu√°l es el planeta m√°s grande?', context: 'Caben 1.300 Tierras dentro.', options: ['Tierra', 'Marte', 'J√∫piter'], correct: 'J√∫piter', explanation: 'J√öPITER es el planeta m√°s GRANDE. Es tan enorme que dentro cabr√≠an 1.300 Tierras. ¬°Es un gigante gaseoso!' },
            { id: 'pla_2', q: '¬øQu√© planeta tiene anillos visibles?', context: 'Son de hielo y roca.', options: ['Saturno', 'Venus', 'Mercurio'], correct: 'Saturno', explanation: 'SATURNO tiene los ANILLOS m√°s visibles. Est√°n hechos de millones de trozos de hielo y roca.' },
            { id: 'pla_3', q: '¬øEn qu√© planeta vivimos?', context: 'Tiene agua y vida.', options: ['Marte', 'Tierra', 'Luna'], correct: 'Tierra', explanation: 'La TIERRA es nuestro hogar. Es el √∫nico planeta conocido con agua l√≠quida y vida.' },
            { id: 'pla_4', q: '¬øQu√© movimiento causa el D√≠a y la Noche?', context: 'Gira como una peonza.', options: ['Traslaci√≥n', 'Rotaci√≥n', '√ìrbita'], correct: 'Rotaci√≥n', explanation: 'La ROTACI√ìN es cuando la Tierra gira sobre s√≠ misma. Tarda 24 horas = 1 d√≠a.' },
            { id: 'pla_5', q: '¬øQu√© movimiento causa las Estaciones?', context: 'Da vueltas alrededor del Sol.', options: ['Traslaci√≥n', 'Rotaci√≥n', 'Giro'], correct: 'Traslaci√≥n', explanation: 'La TRASLACI√ìN es cuando la Tierra da vueltas alrededor del Sol. Tarda 365 d√≠as = 1 a√±o.' },
            { id: 'pla_6', q: '¬øCu√°l es el planeta m√°s cercano al Sol?', context: 'Es muy caliente.', options: ['Venus', 'Mercurio', 'Tierra'], correct: 'Mercurio', explanation: 'MERCURIO es el m√°s cercano al Sol. Por eso hace mucho calor durante el d√≠a.' },
            { id: 'pla_7', q: '¬øCu√°l es el planeta m√°s caliente?', context: 'Tiene una atm√≥sfera muy densa.', options: ['Mercurio', 'Venus', 'Marte'], correct: 'Venus', explanation: 'VENUS es el m√°s CALIENTE (460¬∞C) porque su atm√≥sfera atrapa el calor como un invernadero.' },
            { id: 'pla_8', q: '¬øQu√© planeta es conocido como "el planeta rojo"?', context: 'Tiene mucho hierro.', options: ['J√∫piter', 'Marte', 'Saturno'], correct: 'Marte', explanation: 'MARTE es rojo por el √≥xido de hierro en su superficie. ¬°Es el objetivo de las misiones espaciales!' },
            { id: 'pla_9', q: '¬øCu√°ntos planetas hay en el Sistema Solar?', context: 'Contando desde Mercurio.', options: ['7', '8', '9'], correct: '8', explanation: 'Hay 8 PLANETAS: Mercurio, Venus, Tierra, Marte, J√∫piter, Saturno, Urano y Neptuno. (Plut√≥n ya no es planeta).' },
            { id: 'pla_10', q: '¬øQu√© es la Luna?', context: 'Gira alrededor de la Tierra.', options: ['Un planeta', 'Un sat√©lite', 'Una estrella'], correct: 'Un sat√©lite', explanation: 'La LUNA es un SAT√âLITE natural de la Tierra. Gira alrededor de nuestro planeta.' }
        ]
    }
};

/* ============================================================================
   MOTOR MATEM√ÅTICO INFINITO
   ============================================================================ */

const mathEngine = {
    generate: function(topic, level) {
        let n1, n2, n3, res, text, context, hint;
        const l = Math.max(1, Math.min(5, level));

        // Generadores con contexto para TODAS las operaciones
        if (topic === 'sumas') {
            const contexts = [
                { t: 'En una caja hay {n1} manzanas. A√±adimos {n2} m√°s.', q: '¬øCu√°ntas manzanas hay ahora?' },
                { t: 'Carla tiene {n1} cromos. Su amigo le da {n2}.', q: '¬øCu√°ntos cromos tiene en total?' },
                { t: 'En un √°rbol hay {n1} p√°jaros. Llegan {n2} m√°s.', q: '¬øCu√°ntos p√°jaros hay ahora?' }
            ];
            const ctx = contexts[Math.floor(Math.random() * contexts.length)];
            if (l < 3) { n1 = r(10, 50); n2 = r(10, 50); }
            else if (l < 5) { n1 = r(100, 500); n2 = r(100, 500); }
            else { n1 = r(500, 1000); n2 = r(500, 1000); }
            return {
                type: 'input',
                context: ctx.t.replace('{n1}', n1).replace('{n2}', n2),
                q: ctx.q,
                a: n1 + n2,
                hint: 'Suma las dos cantidades',
                explanation: `Has sumado ${n1} + ${n2} = ${n1+n2}. ¬°La suma es la operaci√≥n de a√±adir!`
            };
        }
        if (topic === 'restas') {
            const contexts = [
                { t: 'Hay {n1} galletas. Nos comemos {n2}.', q: '¬øCu√°ntas galletas quedan?' },
                { t: 'En un autob√∫s van {n1} personas. Se bajan {n2}.', q: '¬øCu√°ntas personas quedan?' },
                { t: 'Tenemos {n1} euros. Gastamos {n2}.', q: '¬øCu√°nto dinero nos queda?' }
            ];
            const ctx = contexts[Math.floor(Math.random() * contexts.length)];
            if (l < 3) { n1 = r(50, 90); n2 = r(10, 40); }
            else { n1 = r(200, 900); n2 = r(50, n1-10); }
            return {
                type: 'input',
                context: ctx.t.replace('{n1}', n1).replace('{n2}', n2),
                q: ctx.q,
                a: n1 - n2,
                hint: 'Resta lo que se va del total',
                explanation: `Has restado ${n1} - ${n2} = ${n1-n2}. ¬°La resta es la operaci√≥n de quitar!`
            };
        }
        if (topic === 'mult') {
            const contexts = [
                { t: 'Compramos {n2} cajas con {n1} l√°pices cada una.', q: '¬øCu√°ntos l√°pices tenemos en total?' },
                { t: 'Hay {n2} bolsas con {n1} caramelos cada una.', q: '¬øCu√°ntos caramelos hay en total?' },
                { t: 'Un libro cuesta {n1} euros. Compramos {n2} libros.', q: '¬øCu√°nto pagamos en total?' }
            ];
            const ctx = contexts[Math.floor(Math.random() * contexts.length)];
            if (l < 3) { n1 = r(2, 5); n2 = r(2, 9); }
            else { n1 = r(6, 9); n2 = r(6, 12); }
            return {
                type: 'input',
                context: ctx.t.replace('{n1}', n1).replace('{n2}', n2),
                q: ctx.q,
                a: n1 * n2,
                hint: 'Multiplica usando las tablas',
                explanation: `Has multiplicado ${n1} √ó ${n2} = ${n1*n2}. ¬°La multiplicaci√≥n es sumar varias veces el mismo n√∫mero!`
            };
        }
        if (topic === 'div') {
            const contexts = [
                { t: 'Repartimos {n1} caramelos entre {n2} ni√±os.', q: '¬øCu√°ntos caramelos le tocan a cada uno?' },
                { t: 'Tenemos {n1} galletas para {n2} amigos.', q: '¬øCu√°ntas galletas le tocan a cada uno?' },
                { t: 'Dividimos {n1} euros entre {n2} personas.', q: '¬øCu√°nto dinero le toca a cada uno?' }
            ];
            const ctx = contexts[Math.floor(Math.random() * contexts.length)];
            if (l < 3) { n2 = r(2, 5); res = r(2, 9); }
            else { n2 = r(6, 9); res = r(10, 20); }
            n1 = n2 * res;
            return {
                type: 'input',
                context: ctx.t.replace('{n1}', n1).replace('{n2}', n2),
                q: ctx.q,
                a: res,
                hint: `Piensa: ¬øQu√© n√∫mero por ${n2} da ${n1}?`,
                explanation: `Has dividido ${n1} : ${n2} = ${res}. ¬°La divisi√≥n es repartir en partes iguales!`
            };
        }
        if (topic === 'fraccion') {
            // PROBLEMAS DE FRACCIONES CON CONTEXTO (100% problemas)
            const problems = [
                {
                    context: 'Para merendar, tu abuela ha hecho una tortilla de patatas riqu√≠sima y la ha cortado en 4 trozos iguales.',
                    q: 'Si t√∫ te comes 1 trozo, ¬øqu√© fracci√≥n de la tortilla te has comido?',
                    setup: { total: 4, eaten: 1 },
                    a: '1/4',
                    explanation: 'La tortilla tiene 4 partes (denominador). Te comes 1 parte (numerador). Por eso es 1/4. ¬°Quedan 3/4 para el abuelo!'
                },
                {
                    context: 'Imagina que tenemos un dibujo con 8 olivos de Ja√©n.',
                    q: 'Si pintamos la mitad (1/2) de los olivos de color verde oscuro, ¬øcu√°ntos olivos hay de color verde oscuro?',
                    setup: { total: 8, fraction: '1/2' },
                    a: '4',
                    explanation: 'La mitad de 8 es 4. Porque 8 dividido entre 2 = 4. ¬°Hay 4 olivos verde oscuro y 4 verde claro!'
                },
                {
                    context: 'La familia va en coche a la playa de Matalasca√±as. El camino es largo.',
                    q: 'Si ya hemos recorrido un tercio (1/3) del camino, ¬øcu√°ntas partes nos faltan para llegar?',
                    setup: { total: 3, done: 1 },
                    a: '2',
                    explanation: 'El camino tiene 3 partes. Hemos hecho 1 parte. Faltan 3-1=2 partes. ¬°Casi llegamos!'
                },
                {
                    context: 'En un plato hay 6 pesti√±os con miel t√≠picos de Andaluc√≠a.',
                    q: 'Tu hermano se come 2/6 de los pesti√±os. ¬øCu√°ntos pesti√±os se ha comido exactamente?',
                    setup: { total: 6, fraction: '2/6' },
                    a: '2',
                    explanation: 'El plato tiene 6 partes. Tu hermano coge 2 partes. ¬°Se ha comido 2 pesti√±os! Quedan 4.'
                },
                {
                    context: 'Una pizza est√° cortada en 8 porciones iguales.',
                    q: 'Si te comes 3 porciones, ¬øqu√© fracci√≥n de la pizza te has comido?',
                    setup: { total: 8, eaten: 3 },
                    a: '3/8',
                    explanation: 'La pizza tiene 8 partes (denominador). Te comes 3 partes (numerador). Por eso es 3/8.'
                },
                {
                    context: 'Una tarta de cumplea√±os tiene 12 trozos.',
                    q: 'Si en la fiesta se comen 5 trozos, ¬øqu√© fracci√≥n de la tarta se han comido?',
                    setup: { total: 12, eaten: 5 },
                    a: '5/12',
                    explanation: 'La tarta tiene 12 partes. Se comen 5 partes. La fracci√≥n es 5/12.'
                },
                {
                    context: 'Un dep√≥sito de agua tiene 10 partes iguales.',
                    q: 'Si est√° lleno hasta 7 partes, ¬øqu√© fracci√≥n del dep√≥sito est√° llena?',
                    setup: { total: 10, filled: 7 },
                    a: '7/10',
                    explanation: 'El dep√≥sito tiene 10 partes. Est√° lleno hasta 7. La fracci√≥n es 7/10.'
                },
                {
                    context: 'Una barra de pan se corta en 6 rebanadas iguales.',
                    q: 'Si desayunas 2 rebanadas, ¬øqu√© fracci√≥n de la barra te has comido?',
                    setup: { total: 6, eaten: 2 },
                    a: '2/6',
                    explanation: 'La barra tiene 6 partes. Te comes 2. La fracci√≥n es 2/6 (que es lo mismo que 1/3).'
                },
                {
                    context: 'Un campo de f√∫tbol est√° dividido en 4 cuartos.',
                    q: 'Si hemos jugado en 3 cuartos, ¬øqu√© fracci√≥n del campo hemos recorrido?',
                    setup: { total: 4, done: 3 },
                    a: '3/4',
                    explanation: 'El campo tiene 4 partes. Hemos recorrido 3. La fracci√≥n es 3/4.'
                },
                {
                    context: 'Una caja de huevos tiene 12 huecos.',
                    q: 'Si hay 9 huevos dentro, ¬øqu√© fracci√≥n de la caja est√° ocupada?',
                    setup: { total: 12, filled: 9 },
                    a: '9/12',
                    explanation: 'La caja tiene 12 partes. Hay 9 huevos. La fracci√≥n es 9/12 (que es lo mismo que 3/4).'
                }
            ];
            const prob = problems[Math.floor(Math.random() * problems.length)];
            return {
                type: 'input',
                context: prob.context,
                q: prob.q,
                a: prob.a,
                hint: 'Piensa: total de partes y partes que tomamos',
                explanation: prob.explanation,
                isFraction: true
            };
        }
        if (topic === 'problema') {
            // Problemas compuestos (2 operaciones)
            const problems = [
                { t: 'Carla tiene {n1}‚Ç¨. Gasta {n2}‚Ç¨ en un libro y luego su abuela le da {n3}‚Ç¨. ¬øCu√°nto tiene ahora?', a: (n1,n2,n3) => (n1-n2)+n3, hint: 'Primero resta, luego suma' },
                { t: 'En un autob√∫s van {n1} personas. En la parada 1 bajan {n2} y suben {n3}. ¬øCu√°ntas quedan?', a: (n1,n2,n3) => (n1-n2)+n3, hint: 'Sigue el orden de la historia' },
                { t: 'Compramos {n2} paquetes de {n1} cromos. Ya ten√≠amos {n3} cromos. ¬øCu√°ntos tenemos?', a: (n1,n2,n3) => (n1*n2)+n3, hint: 'Primero multiplica, luego suma' },
                { t: 'Tenemos {n1} manzanas. Las repartimos entre {n2} ni√±os. Cada ni√±o come {n3}. ¬øCu√°ntas le sobran a cada uno?', a: (n1,n2,n3) => Math.floor(n1/n2)-n3, hint: 'Primero divide, luego resta' },
                { t: 'Un libro tiene {n1} p√°ginas. Carla lee {n2} el lunes y {n3} el martes. ¬øCu√°ntas le quedan?', a: (n1,n2,n3) => n1-n2-n3, hint: 'Resta lo que ha le√≠do del total' }
            ];
            const prob = problems[Math.floor(Math.random() * problems.length)];
            if (l < 3) {
                n1 = r(20, 50); n2 = r(5, 15); n3 = r(3, 10);
            } else {
                n1 = r(50, 150); n2 = r(10, 40); n3 = r(5, 20);
            }
            const answer = prob.a(n1, n2, n3);
            return {
                type: 'input',
                context: 'Problema de varias operaciones:',
                q: prob.t.replace('{n1}', n1).replace('{n2}', n2).replace('{n3}', n3),
                a: answer,
                hint: prob.hint,
                explanation: `Primero haz una operaci√≥n, luego la otra. El resultado es ${answer}.`
            };
        }
    }
};

/* ============================================================================
   UTILIDADES
   ============================================================================ */

function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function saveData() {
    if (appState.currentUser) {
        localStorage.setItem('carla_user_' + appState.currentUser.id, JSON.stringify(appState.currentUser));
    }
    localStorage.setItem('carla_users', JSON.stringify(allUsers));
    localStorage.setItem('carla_settings', JSON.stringify({ voiceEnabled: appState.voiceEnabled }));
}

function loadData() {
    const settings = localStorage.getItem('carla_settings');
    if (settings) {
        const s = JSON.parse(settings);
        appState.voiceEnabled = s.voiceEnabled !== undefined ? s.voiceEnabled : true;
    }
}

function createUserId(name, emojis) {
    return name + '_' + emojis.join('');
}

/* ============================================================================
   GESTI√ìN DE USUARIOS
   ============================================================================ */

let allUsers = JSON.parse(localStorage.getItem('carla_users')) || [];

function initLoginScreen() {
    // Crear selectores de emojis
    ['login', 'new'].forEach(prefix => {
        const container = document.getElementById(prefix + '-emoji-selector');
        container.innerHTML = '';
        EMOJI_OPTIONS.forEach(emoji => {
            const div = document.createElement('div');
            div.className = 'emoji-option';
            div.innerText = emoji;
            div.onclick = () => selectEmoji(prefix, emoji, div);
            container.appendChild(div);
        });
    });
    loadData();
}

function selectEmoji(prefix, emoji, element) {
    const key = prefix + '-selected';
    if (!appState[key]) appState[key] = [];
    
    if (appState[key].length < 3) {
        appState[key].push(emoji);
        element.classList.add('selected');
        updateEmojiPreview(prefix);
    }
}

function updateEmojiPreview(prefix) {
    const key = prefix + '-selected';
    document.getElementById(prefix + '-emoji-preview').innerText = appState[key] ? appState[key].join(' ') : '';
}

function createUser() {
    const name = document.getElementById('new-name').value.trim();
    const emojis = appState['new-selected'];
    
    if (!name) { alert('Por favor, escribe tu nombre'); return; }
    if (!emojis || emojis.length !== 3) { alert('Selecciona 3 emojis'); return; }
    
    const userId = createUserId(name, emojis);
    
    // Verificar si ya existe
    if (allUsers.find(u => u.id === userId)) {
        alert('Este usuario ya existe. Prueba con otros emojis.');
        return;
    }
    
    // Crear usuario
    const newUser = {
        id: userId,
        name: name,
        emojis: emojis,
        stars: 0,
        level: 1,
        uniqueQuestions: 0,
        questionsDone: {}, // { 'lengua_ortografia': [0,1,2] }
        medals: []
    };
    
    allUsers.push(newUser);
    saveData();
    
    loginUser(newUser);
}

function loginUser(existingUser) {
    const name = document.getElementById('login-name').value.trim();
    const emojis = appState['login-selected'];
    
    if (!name) { alert('Por favor, escribe tu nombre'); return; }
    if (!emojis || emojis.length !== 3) { alert('Selecciona 3 emojis'); return; }
    
    const userId = createUserId(name, emojis);
    const user = existingUser || allUsers.find(u => u.id === userId);
    
    if (!user) {
        alert('Usuario no encontrado. ¬øEres nuevo? Crea tu cuenta.');
        return;
    }
    
    appState.currentUser = user;
    appState.currentUser.questionsDone = appState.currentUser.questionsDone || {};
    
    updateHomeScreen();
    showScreen('screen-home');
}

function logoutUser() {
    appState.currentUser = null;
    appState['new-selected'] = [];
    appState['login-selected'] = [];
    document.getElementById('new-name').value = '';
    document.getElementById('login-name').value = '';
    document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selected'));
    document.querySelectorAll('.emoji-preview').forEach(e => e.innerText = '');
    showScreen('screen-login');
}

function updateHomeScreen() {
    const user = appState.currentUser;
    document.getElementById('header-name').innerText = user.name;
    document.getElementById('header-emojis').innerText = user.emojis.join(' ');
    document.getElementById('total-stars').innerText = user.stars;
    document.getElementById('user-level').innerText = user.level;
    document.getElementById('unique-questions').innerText = user.uniqueQuestions;
    document.getElementById('welcome-title').innerText = '¬°Hola ' + user.name + '!';
}

function resetUserProgress() {
    if (confirm('¬øSeguro que quieres borrar TU progreso? Esto no se puede deshacer.')) {
        appState.currentUser.stars = 0;
        appState.currentUser.level = 1;
        appState.currentUser.uniqueQuestions = 0;
        appState.currentUser.questionsDone = {};
        saveData();
        updateHomeScreen();
        alert('Tu progreso ha sido reiniciado.');
    }
}

function deleteAllUsers() {
    if (confirm('‚ö†Ô∏è ¬øSeguro que quieres BORRAR TODOS los usuarios? Esto eliminar√° el progreso de toda la clase.')) {
        allUsers = [];
        localStorage.removeItem('carla_users');
        logoutUser();
        alert('Todos los usuarios han sido eliminados.');
    }
}

/* ============================================================================
   NAVEGACI√ìN Y JUEGO
   ============================================================================ */

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // Actualizar estad√≠sticas en cada pantalla
    if (appState.currentUser) {
        document.getElementById('subject-stars').innerText = appState.currentUser.stars;
        document.getElementById('topic-stars').innerText = appState.currentUser.stars;
        document.getElementById('game-stars').innerText = appState.currentUser.stars;
        document.getElementById('rewards-stars').innerText = appState.currentUser.stars;
        document.getElementById('reward-unique').innerText = appState.currentUser.uniqueQuestions;
        document.getElementById('reward-level').innerText = appState.currentUser.level;
    }
    document.getElementById('settings-voice').innerText = appState.voiceEnabled ? 'ON' : 'OFF';
}

function selectSubject(subj) {
    gameState.subject = subj;
    const titles = { 'mates': 'üßÆ Matem√°ticas', 'lengua': 'üìñ Lengua Castellana', 'medio': 'üåç Conocimiento del Medio' };
    document.getElementById('topic-title').innerText = titles[subj];
    
    const list = document.getElementById('topics-list');
    list.innerHTML = '';
    
    let topics = [];
    if (subj === 'mates') topics = [
        {id:'sumas', name:'‚ûï Sumas con Problemas'}, {id:'restas', name:'‚ûñ Restas con Problemas'}, 
        {id:'mult', name:'‚úñÔ∏è Multiplicaci√≥n'}, {id:'div', name:'‚ûó Divisiones'},
        {id:'fraccion', name:'üçï Fracciones'}, {id:'problema', name:'üß© Problemas Compuestos'}
    ];
    if (subj === 'lengua') topics = [
        {id:'ortografia', name:'üÖ±Ô∏è Ortograf√≠a'}, {id:'gramatica', name:'üìù Gram√°tica'},
        {id:'sinonimos', name:'üîÑ Sin√≥nimos'}, {id:'antonimos', name:'‚ÜîÔ∏è Ant√≥nimos'}
    ];
    if (subj === 'medio') topics = [
        {id:'animales', name:'ü¶Å Animales'}, {id:'cuerpo', name:'ü´Ä Cuerpo Humano'}, {id:'planeta', name:'ü™ê El Universo'}
    ];

    topics.forEach(t => {
        let btn = document.createElement('button');
        btn.className = 'secondary';
        btn.innerText = t.name;
        btn.onclick = () => startGame(t.id);
        list.appendChild(btn);
    });
    
    showScreen('screen-topics');
}

function startGame(topicId) {
    gameState.topic = topicId;
    gameState.sessionStars = 0;
    gameState.attempts = 0;
    gameState.streak = 0;
    showScreen('screen-game');
    loadQuestion();
}

function getAvailableQuestions(subject, topic) {
    const user = appState.currentUser;
    const key = subject + '_' + topic;
    const done = user.questionsDone[key] || [];
    
    if (subject === 'mates') {
        // Matem√°ticas son infinitas, no hay l√≠mite
        return { infinite: true };
    }
    
    const bank = questionBank[subject][topic];
    const available = bank.filter((q, index) => !done.includes(index));
    
    return { infinite: false, available, done, total: bank.length };
}

function markQuestionDone(subject, topic, index) {
    const user = appState.currentUser;
    const key = subject + '_' + topic;
    if (!user.questionsDone[key]) user.questionsDone[key] = [];
    if (!user.questionsDone[key].includes(index)) {
        user.questionsDone[key].push(index);
        user.uniqueQuestions++;
    }
    saveData();
}

function loadQuestion() {
    gameState.attempts = 0;
    document.getElementById('game-progress').style.width = '0%';
    const areaOpt = document.getElementById('options-area');
    const areaInp = document.getElementById('input-area');
    const btnSub = document.getElementById('btn-submit');
    const contextDiv = document.getElementById('question-context');
    
    areaOpt.innerHTML = '';
    areaInp.innerHTML = '';
    contextDiv.innerHTML = '';
    btnSub.style.display = 'none';

    // Verificar preguntas disponibles
    const available = getAvailableQuestions(gameState.subject, gameState.topic);
    
    if (!available.infinite && available.available.length === 0) {
        // Reciclar preguntas antiguas
        alert('¬°Has completado todas las preguntas de este tema! Vamos a repasar algunas anteriores.');
        appState.currentUser.questionsDone[gameState.subject + '_' + gameState.topic] = [];
        saveData();
    }

    // Generar Pregunta
    if (gameState.subject === 'mates') {
        gameState.currentQ = mathEngine.generate(gameState.topic, appState.currentUser.level);
        document.getElementById('question-emoji').innerText = 'üßÆ';
    } else {
        const bank = questionBank[gameState.subject][gameState.topic];
        const availableQ = getAvailableQuestions(gameState.subject, gameState.topic);
        const availableIndices = bank.map((q, i) => i).filter(i => !availableQ.done.includes(i));
        const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
        gameState.currentQ = { ...bank[randomIndex], _index: randomIndex };
        document.getElementById('question-emoji').innerText = gameState.subject === 'lengua' ? 'üìñ' : 'üåç';
    }

    // Renderizar Contexto
    if (gameState.currentQ.context) {
        contextDiv.innerHTML = gameState.currentQ.context;
    }

    // Renderizar Pregunta
    document.getElementById('question-text').innerHTML = gameState.currentQ.q;

    if (gameState.currentQ.type === 'input' || !gameState.currentQ.options) {
        let inp = document.createElement('input');
        inp.type = gameState.subject === 'mates' && gameState.topic !== 'fraccion' ? 'number' : 'text';
        inp.id = 'user-input';
        inp.placeholder = 'Escribe tu respuesta...';
        inp.onkeypress = (e) => { if(e.key==='Enter') checkInputAnswer(); };
        areaInp.appendChild(inp);
        btnSub.style.display = 'inline-block';
        setTimeout(() => inp.focus(), 500);
    } else {
        gameState.currentQ.options.forEach(opt => {
            let btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkOptionAnswer(btn, opt);
            areaOpt.appendChild(btn);
        });
    }
}

function checkInputAnswer() {
    let val = document.getElementById('user-input').value.trim();
    if (!val) return;
    
    if (gameState.subject === 'mates') {
        if (gameState.topic === 'fraccion') {
             if (val.replace(/\s/g,'') === gameState.currentQ.a.replace(/\s/g,'')) handleSuccess();
             else handleFail();
        } else {
            if (parseInt(val) === gameState.currentQ.a) handleSuccess();
            else handleFail();
        }
    } else {
        if (val.toLowerCase() === gameState.currentQ.a.toLowerCase()) handleSuccess();
        else handleFail();
    }
}

function checkOptionAnswer(btnElement, selectedValue) {
    if (btnElement.classList.contains('correct') || btnElement.classList.contains('wrong')) return;

    gameState.attempts++;
    
    if (selectedValue === gameState.currentQ.correct) {
        btnElement.classList.add('correct');
        handleSuccess();
    } else {
        btnElement.classList.add('wrong');
        handleFail(false); 
    }
}

function handleSuccess() {
    let starsGain = gameState.attempts === 0 ? 2 : 1;
    
    appState.currentUser.stars += starsGain;
    gameState.sessionStars += starsGain;
    gameState.streak++;
    
    // Marcar pregunta como hecha (si no es mates)
    if (gameState.subject !== 'mates' && gameState.currentQ._index !== undefined) {
        markQuestionDone(gameState.subject, gameState.topic, gameState.currentQ._index);
    }
    
    // Subir nivel cada 5 aciertos seguidos
    if (gameState.streak % 5 === 0) {
        appState.currentUser.level++;
        createConfetti();
    }
    
    saveData();
    updateHomeScreen();
    showFeedback(true);
}

function handleFail() {
    gameState.streak = 0;
    if (gameState.currentQ.type === 'input' || !gameState.currentQ.options) {
        document.getElementById('user-input').value = '';
        document.getElementById('user-input').focus();
    }
}

function showFeedback(isCorrect) {
    const modal = document.getElementById('feedback-modal');
    const title = document.getElementById('fb-title');
    const content = document.getElementById('fb-content');
    const icon = document.getElementById('fb-icon');
    
    modal.style.display = 'flex';
    
    if (isCorrect) {
        title.innerText = gameState.attempts === 0 ? '¬°Excelente!' : '¬°Correcto!';
        icon.innerText = 'üéâ';
        
        let html = '';
        if (gameState.currentQ.explanation) {
            html = '<div class="feedback-explanation"><b>üí° Explicaci√≥n:</b><br>' + gameState.currentQ.explanation + '</div>';
        }
        content.innerHTML = html;
    }
}

function nextQuestion() {
    document.getElementById('feedback-modal').style.display = 'none';
    loadQuestion();
}

function toggleVoice() {
    appState.voiceEnabled = !appState.voiceEnabled;
    saveData();
    document.getElementById('settings-voice').innerText = appState.voiceEnabled ? 'ON' : 'OFF';
    document.getElementById('voice-status').innerText = appState.voiceEnabled ? 'ON' : 'OFF';
}

function createConfetti() {
    for (let i = 0; i < 30; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.background = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#A8D8EA'][Math.floor(Math.random() * 4)];
        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 4000);
    }
}

// Inicializar
initLoginScreen();

</script>
</body>
</html>
