<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escuela de Carla ğŸ’</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --dark: #292f36;
            --light: #f7fff7;
            --font-main: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--secondary);
            margin: 0;
            padding: 0;
            text-align: center;
            color: var(--dark);
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: var(--primary); font-size: 2rem; margin: 10px 0; }
        h2 { color: var(--dark); font-size: 1.5rem; }
        h3 { color: var(--primary); font-size: 1.2rem; }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 1.2rem;
            border-radius: 15px;
            margin: 8px;
            cursor: pointer;
            font-family: var(--font-main);
            box-shadow: 0 5px 0 #c0392b;
            transition: transform 0.1s;
            width: 90%;
            max-width: 350px;
        }
        button:active { transform: translateY(4px); box-shadow: 0 1px 0 #c0392b; }
        button.secondary { background-color: var(--secondary); box-shadow: 0 5px 0 #16a085; }
        button.accent { background-color: var(--accent); color: var(--dark); box-shadow: 0 5px 0 #f1c40f; }

        .screen { display: none; width: 100%; flex-direction: column; align-items: center; }
        .active { display: flex; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .question-box {
            background: #fff;
            border: 3px dashed var(--primary);
            padding: 25px;
            border-radius: 20px;
            margin: 15px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .question-text { font-size: 2rem; font-weight: bold; margin-bottom: 15px; color: var(--dark); }
        .question-hint { font-size: 1.1rem; color: #666; margin-bottom: 15px; font-style: italic; }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }
        .option-btn {
            background-color: white;
            color: var(--dark);
            border: 2px solid var(--secondary);
            box-shadow: 0 4px 0 #bdc3c7;
            font-size: 1.1rem;
        }
        .option-btn.correct { background-color: #2ecc71; color: white; border-color: #27ae60; }
        .option-btn.wrong { background-color: #e74c3c; color: white; border-color: #c0392b; }

        input[type="text"], input[type="number"] {
            font-size: 1.8rem;
            padding: 15px;
            width: 80%;
            text-align: center;
            border: 3px solid var(--primary);
            border-radius: 15px;
            font-family: var(--font-main);
            margin-bottom: 10px;
        }

        .top-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--dark);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }
        .voice-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: none;
            padding: 0;
            width: auto;
            margin: 0;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: var(--dark);
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .medal-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .medal-item { text-align: center; width: 80px; }
        .medal-icon { font-size: 3rem; filter: grayscale(100%); opacity: 0.4; transition: 0.5s; }
        .medal-item.unlocked .medal-icon { filter: grayscale(0%); opacity: 1; transform: scale(1.1); }
        .medal-name { font-size: 0.8rem; font-weight: bold; margin-top: 5px; }

        .emoji-display { font-size: 4rem; margin: 10px 0; }
        
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            font-size: 1.5rem;
        }
        .fraction .top { border-bottom: 2px solid var(--dark); display: block; padding: 0 5px; }
        .fraction .bottom { display: block; padding: 0 5px; }

        .progress-container {
            width: 100%;
            background: #eee;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            width: 0%;
            transition: width 0.5s;
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- PANTALLA 1: INICIO -->
    <div id="screen-home" class="screen active">
        <h1>Â¡Hola Carla! ğŸ’</h1>
        <div class="emoji-display">ğŸ‘©â€ğŸ“</div>
        
        <div class="stats-bar">
            <span>â­ <span id="total-stars">0</span></span>
            <span>ğŸ† <span id="user-level">Novata</span></span>
        </div>

        <button onclick="showScreen('screen-subjects')">ğŸ“š Asignaturas</button>
        <button class="secondary" onclick="showScreen('screen-rewards')">ğŸ… Mis Logros</button>
        <button class="accent" onclick="showScreen('screen-settings')">âš™ï¸ ConfiguraciÃ³n</button>
    </div>

    <!-- PANTALLA 2: SELECCIÃ“N ASIGNATURA -->
    <div id="screen-subjects" class="screen">
        <h2>Â¿QuÃ© estudiamos hoy?</h2>
        <button onclick="selectSubject('mates')" style="background:#FF9F43">ğŸ§® MatemÃ¡ticas</button>
        <button onclick="selectSubject('lengua')" style="background:#54a0ff">ğŸ“– Lengua Castellana</button>
        <button onclick="selectSubject('medio')" style="background:#1dd1a1">ğŸŒ Conocimiento del Medio</button>
        <button class="secondary" onclick="showScreen('screen-home')">ğŸ  Volver</button>
    </div>

    <!-- PANTALLA 3: SELECCIÃ“N TEMA -->
    <div id="screen-topics" class="screen">
        <h2 id="subject-title">Tema</h2>
        <div id="topics-container" style="width: 100%;"></div>
        <button class="secondary" onclick="showScreen('screen-subjects')" style="margin-top:20px">ğŸ”™ AtrÃ¡s</button>
    </div>

    <!-- PANTALLA 4: JUEGO -->
    <div id="screen-game" class="screen">
        <div class="top-bar">
            <button class="voice-btn" onclick="speakCurrentText()">ğŸ”Š</button>
            <span id="game-subtitle">Pregunta</span>
            <span>â­ <span id="session-stars">0</span></span>
        </div>

        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div id="emoji-display" class="emoji-display"></div>

        <div class="question-box">
            <div id="question-hint" class="question-hint"></div>
            <div id="question-text" class="question-text">...</div>
            <div id="answer-area"></div>
        </div>

        <button id="btn-check" class="accent" onclick="checkAnswer()" style="display:none;">âœ… Comprobar</button>
        <button class="secondary" onclick="showScreen('screen-topics')">ğŸ”™ Salir</button>
    </div>

    <!-- PANTALLA 5: RECOMPENSAS -->
    <div id="screen-rewards" class="screen">
        <h2>ğŸ† Tu Muro de la Fama</h2>
        <p>Consigue estrellas para desbloquear medallas.</p>
        <div class="medal-grid">
            <div class="medal-item" id="medal-1"><div class="medal-icon">ğŸ¥‰</div><div class="medal-name">Bronce</div></div>
            <div class="medal-item" id="medal-2"><div class="medal-icon">ğŸ¥ˆ</div><div class="medal-name">Plata</div></div>
            <div class="medal-item" id="medal-3"><div class="medal-icon">ğŸ¥‡</div><div class="medal-name">Oro</div></div>
            <div class="medal-item" id="medal-4"><div class="medal-icon">ğŸ‘‘</div><div class="medal-name">Reina</div></div>
            <div class="medal-item" id="medal-5"><div class="medal-icon">ğŸš€</div><div class="medal-name">Astronauta</div></div>
            <div class="medal-item" id="medal-6"><div class="medal-icon">ğŸ¦„</div><div class="medal-name">MÃ¡gica</div></div>
            <div class="medal-item" id="medal-7"><div class="medal-icon">ğŸŒŸ</div><div class="medal-name">Estelar</div></div>
            <div class="medal-item" id="medal-8"><div class="medal-icon">ğŸ’</div><div class="medal-name">Diamante</div></div>
        </div>
        <br>
        <button class="secondary" onclick="showScreen('screen-home')">ğŸ  Volver</button>
    </div>

    <!-- PANTALLA 6: CONFIGURACIÃ“N -->
    <div id="screen-settings" class="screen">
        <h2>âš™ï¸ ConfiguraciÃ³n</h2>
        <button class="secondary" onclick="toggleVoice()">ğŸ”Š Voz: <span id="voice-status">ON</span></button>
        <button class="accent" onclick="resetProgress()">âš ï¸ Borrar Todo el Progreso</button>
        <button class="secondary" onclick="showScreen('screen-home')">ğŸ  Volver</button>
    </div>

</div>

<script>
/* ============================================================================
   GENERADORES INFINITOS DE PREGUNTAS - TODAS LAS ASIGNATURAS
   ============================================================================ */

const db = {
    mates: [
        { 
            id: 'sumas', 
            name: 'â• Sumas', 
            type: 'input', 
            emoji: 'ğŸ§®',
            gen: () => {
                let dificultad = Math.floor(stars / 50); // Aumenta con el progreso
                let max = 100 + (dificultad * 100);
                let n1 = Math.floor(Math.random() * max) + 10;
                let n2 = Math.floor(Math.random() * max) + 10;
                return { 
                    q: `${n1} + ${n2}`, 
                    a: n1 + n2, 
                    text: `CuÃ¡nto es ${n1} mÃ¡s ${n2}`,
                    hint: 'Suma las dos cantidades'
                };
            }
        },
        { 
            id: 'restas', 
            name: 'â– Restas', 
            type: 'input', 
            emoji: 'âœï¸',
            gen: () => {
                let dificultad = Math.floor(stars / 50);
                let max = 100 + (dificultad * 100);
                let n1 = Math.floor(Math.random() * max) + 50;
                let n2 = Math.floor(Math.random() * (n1 - 10)) + 1;
                return { 
                    q: `${n1} - ${n2}`, 
                    a: n1 - n2, 
                    text: `CuÃ¡nto es ${n1} menos ${n2}`,
                    hint: 'Resta el nÃºmero pequeÃ±o del grande'
                };
            }
        },
        { 
            id: 'multiplicar', 
            name: 'âœ–ï¸ Tablas de Multiplicar', 
            type: 'input', 
            emoji: 'ğŸ“Š',
            gen: () => {
                let n1 = Math.floor(Math.random() * 9) + 2;
                let n2 = Math.floor(Math.random() * 10) + 1;
                return { 
                    q: `${n1} Ã— ${n2}`, 
                    a: n1 * n2, 
                    text: `CuÃ¡nto es ${n1} por ${n2}`,
                    hint: `Piensa en la tabla del ${n1}`
                };
            }
        },
        { 
            id: 'divisiones', 
            name: 'â— Divisiones Exactas', 
            type: 'input', 
            emoji: 'ğŸ°',
            gen: () => {
                let divisor = Math.floor(Math.random() * 8) + 2;
                let cociente = Math.floor(Math.random() * 10) + 1;
                let dividendo = divisor * cociente;
                return { 
                    q: `${dividendo} : ${divisor}`, 
                    a: cociente, 
                    text: `CuÃ¡nto es ${dividendo} entre ${divisor}`,
                    hint: 'Â¿QuÃ© nÃºmero multiplicado por el divisor da el dividendo?'
                };
            }
        },
        { 
            id: 'fracciones_suma', 
            name: 'ğŸ• Fracciones - Sumas (mismo denominador)', 
            type: 'input', 
            emoji: 'ğŸ•',
            gen: () => {
                let denom = [2, 3, 4, 5, 6, 8, 10][Math.floor(Math.random() * 7)];
                let num1 = Math.floor(Math.random() * (denom - 1)) + 1;
                let num2 = Math.floor(Math.random() * (denom - num1));
                if (num2 < 1) num2 = 1;
                return { 
                    q: `<div class="fraction"><span class="top">${num1}</span><span class="bottom">${denom}</span></div> + <div class="fraction"><span class="top">${num2}</span><span class="bottom">${denom}</span></div> = ?`,
                    a: `${num1 + num2}/${denom}`,
                    text: `Suma ${num1} entre ${denom} mÃ¡s ${num2} entre ${denom}`,
                    hint: 'Suma los numeradores y mantÃ©n el denominador',
                    isFraction: true
                };
            }
        },
        { 
            id: 'fracciones_comparar', 
            name: 'ğŸ” Fracciones - Comparar', 
            type: 'choice', 
            emoji: 'âš–ï¸',
            gen: () => {
                let denom = [2, 3, 4, 5, 6, 8, 10][Math.floor(Math.random() * 7)];
                let num1 = Math.floor(Math.random() * (denom - 1)) + 1;
                let num2 = Math.floor(Math.random() * (denom - 1)) + 1;
                while (num1 === num2) num2 = Math.floor(Math.random() * (denom - 1)) + 1;
                
                let correct = num1 > num2 ? '>' : '<';
                return { 
                    q: `<div class="fraction"><span class="top">${num1}</span><span class="bottom">${denom}</span></div> ___ <div class="fraction"><span class="top">${num2}</span><span class="bottom">${denom}</span></div>`,
                    a: correct, 
                    options: ['>', '<'],
                    text: `Compara ${num1} entre ${denom} con ${num2} entre ${denom}`,
                    hint: 'Con el mismo denominador, Â¿quÃ© numerador es mayor?',
                    isFraction: true
                };
            }
        },
        { 
            id: 'fracciones_simple', 
            name: 'ğŸ¯ Fracciones - Identificar', 
            type: 'choice', 
            emoji: 'ğŸ“',
            gen: () => {
                let denom = [2, 3, 4, 5, 6, 8, 10][Math.floor(Math.random() * 7)];
                let num = Math.floor(Math.random() * (denom - 1)) + 1;
                let wrong1 = `${num + 1}/${denom}`;
                let wrong2 = `${num}/${denom + 1}`;
                let correct = `${num}/${denom}`;
                let options = [correct, wrong1, wrong2].sort(() => 0.5 - Math.random());
                
                return { 
                    q: `Â¿CÃ³mo se escribe "${num} partes de ${denom}"?`,
                    a: correct, 
                    options: options,
                    text: `Escribe la fracciÃ³n ${num} entre ${denom}`,
                    hint: 'El nÃºmero de arriba son las partes que tomamos',
                    isFraction: true
                };
            }
        },
        { 
            id: 'problemas_simple', 
            name: 'ğŸ§  Problemas (1 operaciÃ³n)', 
            type: 'input', 
            emoji: 'ğŸ“',
            gen: () => {
                const scenarios = [
                    { t: "Carla tiene {n1} cromos y le regalan {n2} mÃ¡s. Â¿CuÃ¡ntos tiene ahora?", op: '+', emoji: 'ğŸ†' },
                    { t: "En una clase hay {n1} niÃ±os. Se van {n2} al recreo. Â¿CuÃ¡ntos quedan?", op: '-', emoji: 'ğŸ«' },
                    { t: "Una caja tiene {n1} lÃ¡pices. Compramos {n2} cajas iguales. Â¿CuÃ¡ntos lÃ¡pices en total?", op: 'Ã—', emoji: 'âœï¸' },
                    { t: "Repartimos {n1} caramelos entre {n2} niÃ±os. Â¿CuÃ¡ntos caramelos le tocan a cada uno?", op: ':', emoji: 'ğŸ¬' },
                    { t: "Un libro cuesta {n1} euros. Compramos {n2} libros. Â¿CuÃ¡nto pagamos?", op: 'Ã—', emoji: 'ğŸ“š' },
                    { t: "Tenemos {n1} galletas. Nos comemos {n2}. Â¿CuÃ¡ntas quedan?", op: '-', emoji: 'ğŸª' }
                ];
                const s = scenarios[Math.floor(Math.random() * scenarios.length)];
                let n1, n2, ans;
                
                if (s.op === '+') {
                    n1 = Math.floor(Math.random() * 50) + 10;
                    n2 = Math.floor(Math.random() * 30) + 5;
                    ans = n1 + n2;
                } else if (s.op === '-') {
                    n1 = Math.floor(Math.random() * 50) + 30;
                    n2 = Math.floor(Math.random() * (n1 - 10)) + 5;
                    ans = n1 - n2;
                } else if (s.op === 'Ã—') {
                    n1 = Math.floor(Math.random() * 9) + 2;
                    n2 = Math.floor(Math.random() * 5) + 2;
                    ans = n1 * n2;
                } else {
                    n2 = Math.floor(Math.random() * 5) + 2;
                    ans = Math.floor(Math.random() * 10) + 1;
                    n1 = n2 * ans;
                }
                
                return { 
                    q: s.t.replace('{n1}', n1).replace('{n2}', n2), 
                    a: ans, 
                    emoji: s.emoji,
                    text: "Lee el problema cuidadosamente y responde",
                    hint: s.op === '+' ? 'Suma las cantidades' : s.op === '-' ? 'Resta lo que se va' : s.op === 'Ã—' ? 'Multiplica' : 'Divide en partes iguales'
                };
            }
        },
        { 
            id: 'problemas_compuestos', 
            name: 'ğŸ¯ Problemas Compuestos (2 operaciones)', 
            type: 'input', 
            emoji: 'ğŸ§©',
            gen: () => {
                const scenarios = [
                    { 
                        t: "Carla tiene {n1} euros. Su abuela le da {n2} euros. Luego gasta {n3} euros en un libro. Â¿CuÃ¡nto le queda?", 
                        ops: ['+', '-'],
                        calc: (a,b,c) => (a + b) - c,
                        emoji: 'ğŸ’°'
                    },
                    { 
                        t: "En un autobÃºs van {n1} personas. En la primera parada suben {n2} y en la segunda bajan {n3}. Â¿CuÃ¡ntas personas quedan?", 
                        ops: ['+', '-'],
                        calc: (a,b,c) => (a + b) - c,
                        emoji: 'ğŸšŒ'
                    },
                    { 
                        t: "Compramos {n1} paquetes de {n2} cromos cada uno. Ya tenÃ­amos {n3} cromos. Â¿CuÃ¡ntos tenemos en total?", 
                        ops: ['Ã—', '+'],
                        calc: (a,b,c) => (a * b) + c,
                        emoji: 'ğŸ†'
                    },
                    { 
                        t: "Tenemos {n1} manzanas. Las repartimos entre {n2} niÃ±os. Cada niÃ±o come {n3} manzanas. Â¿CuÃ¡ntas le sobran a cada niÃ±o?", 
                        ops: [':', '-'],
                        calc: (a,b,c) => (a / b) - c,
                        emoji: 'ğŸ'
                    },
                    { 
                        t: "Un libro tiene {n1} pÃ¡ginas. Carla lee {n2} pÃ¡ginas el lunes y {n3} el martes. Â¿CuÃ¡ntas pÃ¡ginas le quedan?", 
                        ops: ['-', '-'],
                        calc: (a,b,c) => a - b - c,
                        emoji: 'ğŸ“–'
                    },
                    { 
                        t: "En una granja hay {n1} gallinas y {n2} vacas. Â¿CuÃ¡ntas patas hay en total?", 
                        ops: ['Ã—', '+'],
                        calc: (a,b,c) => (a * 2) + (b * 4),
                        emoji: 'ğŸ”',
                        special: true
                    }
                ];
                
                const s = scenarios[Math.floor(Math.random() * scenarios.length)];
                let n1, n2, n3, ans;
                
                if (s.special) {
                    n1 = Math.floor(Math.random() * 10) + 5;
                    n2 = Math.floor(Math.random() * 5) + 2;
                    ans = (n1 * 2) + (n2 * 4);
                } else if (s.ops.includes(':')) {
                    n2 = Math.floor(Math.random() * 4) + 2;
                    let cociente = Math.floor(Math.random() * 8) + 3;
                    n3 = Math.floor(Math.random() * (cociente - 1)) + 1;
                    n1 = n2 * cociente;
                    ans = cociente - n3;
                } else {
                    n1 = Math.floor(Math.random() * 50) + 20;
                    n2 = Math.floor(Math.random() * 20) + 5;
                    n3 = Math.floor(Math.random() * 15) + 3;
                    ans = s.calc(n1, n2, n3);
                }
                
                return { 
                    q: s.t.replace('{n1}', n1).replace('{n2}', n2).replace('{n3}', n3), 
                    a: ans, 
                    emoji: s.emoji,
                    text: "Lee el problema paso a paso. Haz las dos operaciones.",
                    hint: `Primero ${s.ops[0] === '+' ? 'suma' : s.ops[0] === '-' ? 'resta' : s.ops[0] === 'Ã—' ? 'multiplica' : 'divide'}, luego ${s.ops[1] === '+' ? 'suma' : s.ops[1] === '-' ? 'resta' : s.ops[1] === 'Ã—' ? 'multiplica' : 'divide'}`
                };
            }
        }
    ],
    
    lengua: [
        { 
            id: 'ortografia_bv', 
            name: 'ğŸ…±ï¸ OrtografÃ­a: B o V', 
            type: 'choice', 
            emoji: 'âœï¸',
            gen: () => {
                const words = [
                    { w: 'Burro', l: 'B' }, { w: 'Vaca', l: 'V' }, { w: 'Barco', l: 'B' },
                    { w: 'Ventana', l: 'V' }, { w: 'BebÃ©', l: 'B' }, { w: 'VolcÃ¡n', l: 'V' },
                    { w: 'Biblioteca', l: 'B' }, { w: 'ViolÃ­n', l: 'V' }, { w: 'Bailar', l: 'B' },
                    { w: 'Volar', l: 'V' }, { w: 'Bolso', l: 'B' }, { w: 'Vela', l: 'V' },
                    { w: 'Brazo', l: 'B' }, { w: 'Verde', l: 'V' }, { w: 'Bueno', l: 'B' },
                    { w: 'Viejo', l: 'V' }, { w: 'Boca', l: 'B' }, { w: 'Vino', l: 'V' }
                ];
                const item = words[Math.floor(Math.random() * words.length)];
                let hidden = item.w.replace(item.l, '_');
                let wrong = item.l === 'B' ? 'V' : 'B';
                
                return { 
                    q: `Â¿CÃ³mo se escribe: ${hidden}?`, 
                    a: item.l, 
                    options: ['B', 'V'],
                    text: `Elige la letra que falta en ${hidden}`,
                    hint: `La palabra completa es ${item.w}`
                };
            }
        },
        { 
            id: 'ortografia_gj', 
            name: 'ğŸ“ OrtografÃ­a: G o J', 
            type: 'choice', 
            emoji: 'ğŸ“š',
            gen: () => {
                const words = [
                    { w: 'Gato', l: 'G' }, { w: 'Jirafa', l: 'J' }, { w: 'Galleta', l: 'G' },
                    { w: 'JamÃ³n', l: 'J' }, { w: 'Gusano', l: 'G' }, { w: 'Juguete', l: 'J' },
                    { w: 'Gente', l: 'G' }, { w: 'JardÃ­n', l: 'J' }, { w: 'Gafas', l: 'G' },
                    { w: 'Jueves', l: 'J' }, { w: 'Goma', l: 'G' }, { w: 'JabÃ³n', l: 'J' }
                ];
                const item = words[Math.floor(Math.random() * words.length)];
                let hidden = item.w.replace(item.l, '_');
                let wrong = item.l === 'G' ? 'J' : 'G';
                
                return { 
                    q: `Â¿CÃ³mo se escribe: ${hidden}?`, 
                    a: item.l, 
                    options: ['G', 'J'],
                    text: `Elige la letra que falta en ${hidden}`,
                    hint: `La palabra completa es ${item.w}`
                };
            }
        },
        { 
            id: 'ortografia_h', 
            name: 'ğŸ¤« OrtografÃ­a: H (muda)', 
            type: 'choice', 
            emoji: 'ğŸ”¤',
            gen: () => {
                const words = [
                    { w: 'Huevo', hasH: true }, { w: 'Oso', hasH: false }, 
                    { w: 'Hielo', hasH: true }, { w: 'Ola', hasH: false },
                    { w: 'Hombre', hasH: true }, { w: 'Oro', hasH: false },
                    { w: 'Hormiga', hasH: true }, { w: 'Ojo', hasH: false },
                    { w: 'Hijo', hasH: true }, { w: 'Oca', hasH: false },
                    { w: 'Hueso', hasH: true }, { w: 'Olla', hasH: false }
                ];
                const item = words[Math.floor(Math.random() * words.length)];
                let correct = item.hasH ? `H${item.w.substring(1)}` : item.w;
                let wrong = item.hasH ? item.w.substring(1) : `H${item.w}`;
                
                return { 
                    q: `Â¿CÃ³mo se escribe correctamente?`, 
                    a: correct, 
                    options: [correct, wrong],
                    text: `Elige la forma correcta de escribir ${item.w}`,
                    hint: 'Recuerda: la H no suena pero se escribe en algunas palabras'
                };
            }
        },
        { 
            id: 'sinonimos', 
            name: 'ğŸ”„ SinÃ³nimos', 
            type: 'choice', 
            emoji: 'ğŸ”',
            gen: () => {
                const pairs = [
                    { w: 'Feliz', s: 'Contento' }, { w: 'Triste', s: 'Apenado' },
                    { w: 'Grande', s: 'Enorme' }, { w: 'PequeÃ±o', s: 'Chiquito' },
                    { w: 'RÃ¡pido', s: 'Veloz' }, { w: 'Lento', s: 'Despacio' },
                    { w: 'Bonito', s: 'Hermoso' }, { w: 'Feo', s: 'Horrible' },
                    { w: 'Empezar', s: 'Comenzar' }, { w: 'Terminar', s: 'Acabar' },
                    { w: 'Casa', s: 'Vivienda' }, { w: 'Coche', s: 'AutomÃ³vil' },
                    { w: 'NiÃ±o', s: 'Chico' }, { w: 'Miedo', s: 'Temor' },
                    { w: 'Amigo', s: 'CompaÃ±ero' }, { w: 'Listo', s: 'Inteligente' }
                ];
                const item = pairs[Math.floor(Math.random() * pairs.length)];
                const distractors = ['Triste', 'Lento', 'Feo', 'Grande', 'PequeÃ±o', 'Solo', 'Nuevo', 'Viejo'];
                let wrong1 = distractors[Math.floor(Math.random() * distractors.length)];
                let wrong2 = distractors[Math.floor(Math.random() * distractors.length)];
                while (wrong1 === wrong2 || wrong1 === item.s || wrong2 === item.s) {
                    wrong1 = distractors[Math.floor(Math.random() * distractors.length)];
                    wrong2 = distractors[Math.floor(Math.random() * distractors.length)];
                }
                
                return { 
                    q: `Â¿CuÃ¡l es el sinÃ³nimo de "${item.w}"?`, 
                    a: item.s, 
                    options: [item.s, wrong1, wrong2].sort(() => 0.5 - Math.random()),
                    text: `Busca la palabra que significa lo mismo que ${item.w}`,
                    hint: 'Un sinÃ³nimo es una palabra con significado similar'
                };
            }
        },
        { 
            id: 'antonimos', 
            name: 'â†”ï¸ AntÃ³nimos', 
            type: 'choice', 
            emoji: 'â‡„',
            gen: () => {
                const pairs = [
                    { w: 'Feliz', a: 'Triste' }, { w: 'Grande', a: 'PequeÃ±o' },
                    { w: 'RÃ¡pido', a: 'Lento' }, { w: 'Alto', a: 'Bajo' },
                    { w: 'Bueno', a: 'Malo' }, { w: 'DÃ­a', a: 'Noche' },
                    { w: 'Caliente', a: 'FrÃ­o' }, { w: 'Abierto', a: 'Cerrado' },
                    { w: 'Lleno', a: 'VacÃ­o' }, { w: 'Nuevo', a: 'Viejo' },
                    { w: 'Blanco', a: 'Negro' }, { w: 'Arriba', a: 'Abajo' }
                ];
                const item = pairs[Math.floor(Math.random() * pairs.length)];
                const distractors = ['Feliz', 'Grande', 'RÃ¡pido', 'Alto', 'Bueno', 'Similar', 'Igual', 'Parecido'];
                let wrong1 = distractors[Math.floor(Math.random() * distractors.length)];
                let wrong2 = distractors[Math.floor(Math.random() * distractors.length)];
                
                return { 
                    q: `Â¿CuÃ¡l es el antÃ³nimo de "${item.w}"?`, 
                    a: item.a, 
                    options: [item.a, wrong1, wrong2].sort(() => 0.5 - Math.random()),
                    text: `Busca la palabra que significa lo contrario de ${item.w}`,
                    hint: 'Un antÃ³nimo es una palabra con significado opuesto'
                };
            }
        },
        { 
            id: 'gramatica_genero', 
            name: 'ğŸ‘¦ğŸ‘§ GÃ©nero: Masculino o Femenino', 
            type: 'choice', 
            emoji: 'âš§',
            gen: () => {
                const words = [
                    { w: 'NiÃ±o', g: 'Masculino' }, { w: 'NiÃ±a', g: 'Femenino' },
                    { w: 'Perro', g: 'Masculino' }, { w: 'Gata', g: 'Femenino' },
                    { w: 'Libro', g: 'Masculino' }, { w: 'Mesa', g: 'Femenino' },
                    { w: 'Sol', g: 'Masculino' }, { w: 'Luna', g: 'Femenino' },
                    { w: 'Ãrbol', g: 'Masculino' }, { w: 'Flor', g: 'Femenino' },
                    { w: 'Coche', g: 'Masculino' }, { w: 'Casa', g: 'Femenino' },
                    { w: 'LÃ¡piz', g: 'Masculino' }, { w: 'Silla', g: 'Femenino' }
                ];
                const item = words[Math.floor(Math.random() * words.length)];
                
                return { 
                    q: `La palabra "${item.w}" es de gÃ©nero...`, 
                    a: item.g, 
                    options: ['Masculino', 'Femenino'],
                    text: `Dime si ${item.w} es masculino o femenino`,
                    hint: 'FÃ­jate en el artÃ­culo: el (masculino) o la (femenino)'
                };
            }
        },
        { 
            id: 'gramatica_numero', 
            name: '1ï¸âƒ£2ï¸âƒ£ NÃºmero: Singular o Plural', 
            type: 'choice', 
            emoji: 'ğŸ”¢',
            gen: () => {
                const words = [
                    { w: 'Casa', n: 'Singular' }, { w: 'Casas', n: 'Plural' },
                    { w: 'NiÃ±o', n: 'Singular' }, { w: 'NiÃ±os', n: 'Plural' },
                    { w: 'Ãrbol', n: 'Singular' }, { w: 'Ãrboles', n: 'Plural' },
                    { w: 'Flor', n: 'Singular' }, { w: 'Flores', n: 'Plural' },
                    { w: 'LÃ¡piz', n: 'Singular' }, { w: 'LÃ¡pices', n: 'Plural' },
                    { w: 'Ciudad', n: 'Singular' }, { w: 'Ciudades', n: 'Plural' }
                ];
                const item = words[Math.floor(Math.random() * words.length)];
                
                return { 
                    q: `La palabra "${item.w}" estÃ¡ en nÃºmero...`, 
                    a: item.n, 
                    options: ['Singular', 'Plural'],
                    text: `Dime si ${item.w} es singular o plural`,
                    hint: 'Singular = uno, Plural = varios'
                };
            }
        },
        { 
            id: 'gramatica_categoria', 
            name: 'ğŸ“š CategorÃ­a: Sustantivo, Verbo o Adjetivo', 
            type: 'choice', 
            emoji: 'ğŸ·ï¸',
            gen: () => {
                const words = [
                    { w: 'Correr', c: 'Verbo' }, { w: 'Mesa', c: 'Sustantivo' },
                    { w: 'Rojo', c: 'Adjetivo' }, { w: 'Comer', c: 'Verbo' },
                    { w: 'Perro', c: 'Sustantivo' }, { w: 'Grande', c: 'Adjetivo' },
                    { w: 'Saltar', c: 'Verbo' }, { w: 'Casa', c: 'Sustantivo' },
                    { w: 'Azul', c: 'Adjetivo' }, { w: 'Dormir', c: 'Verbo' },
                    { w: 'Libro', c: 'Sustantivo' }, { w: 'Bonito', c: 'Adjetivo' },
                    { w: 'Escribir', c: 'Verbo' }, { w: 'Escuela', c: 'Sustantivo' },
                    { w: 'PequeÃ±o', c: 'Adjetivo' }, { w: 'Jugar', c: 'Verbo' }
                ];
                const item = words[Math.floor(Math.random() * words.length)];
                
                return { 
                    q: `La palabra "${item.w}" es un/una...`, 
                    a: item.c, 
                    options: ['Sustantivo', 'Verbo', 'Adjetivo'],
                    text: `Â¿QuÃ© tipo de palabra es ${item.w}?`,
                    hint: 'Sustantivo=nombre, Verbo=acciÃ³n, Adjetivo=cualidad'
                };
            }
        },
        { 
            id: 'completar_frase', 
            name: 'âœï¸ Completar la Frase', 
            type: 'choice', 
            emoji: 'ğŸ“',
            gen: () => {
                const frases = [
                    { t: 'El cielo es de color ___', a: 'azul', w: ['verde', 'rojo'] },
                    { t: 'Los peces viven en el ___', a: 'agua', w: ['aire', 'suelo'] },
                    { t: 'El sol sale por la ___', a: 'maÃ±ana', w: ['noche', 'tarde'] },
                    { t: 'Para escribir uso un ___', a: 'lÃ¡piz', w: ['tenedor', 'zapato'] },
                    { t: 'Los pÃ¡jaros tienen ___', a: 'alas', w: ['patas', 'ruedas'] },
                    { t: 'La leche es de color ___', a: 'blanco', w: ['negro', 'azul'] },
                    { t: 'El fuego estÃ¡ ___', a: 'caliente', w: ['frÃ­o', 'mojado'] },
                    { t: 'Dormimos en la ___', a: 'noche', w: ['maÃ±ana', 'comida'] }
                ];
                const item = frases[Math.floor(Math.random() * frases.length)];
                let options = [item.a, item.w[0], item.w[1]].sort(() => 0.5 - Math.random());
                
                return { 
                    q: `Completa: ${item.t}`, 
                    a: item.a, 
                    options: options,
                    text: 'Elige la palabra que completa correctamente la frase',
                    hint: 'Lee la frase completa para entender el significado'
                };
            }
        }
    ],
    
    medio: [
        { 
            id: 'animales_vertebrados', 
            name: 'ğŸ¦´ Animales Vertebrados', 
            type: 'choice', 
            emoji: 'ğŸ¾',
            gen: () => {
                const animals = [
                    { n: 'LeÃ³n', t: 'MamÃ­fero', h: 'Tierra', c: 'CarnÃ­voro' },
                    { n: 'Ãguila', t: 'Ave', h: 'Aire', c: 'CarnÃ­voro' },
                    { n: 'TiburÃ³n', t: 'Pez', h: 'Agua', c: 'CarnÃ­voro' },
                    { n: 'Rana', t: 'Anfibio', h: 'Agua/Tierra', c: 'OmnÃ­voro' },
                    { n: 'Serpiente', t: 'Reptil', h: 'Tierra', c: 'CarnÃ­voro' },
                    { n: 'Elefante', t: 'MamÃ­fero', h: 'Tierra', c: 'HerbÃ­voro' },
                    { n: 'PingÃ¼ino', t: 'Ave', h: 'Tierra/Agua', c: 'CarnÃ­voro' },
                    { n: 'DelfÃ­n', t: 'MamÃ­fero', h: 'Agua', c: 'CarnÃ­voro' },
                    { n: 'Tortuga', t: 'Reptil', h: 'Tierra/Agua', c: 'OmnÃ­voro' },
                    { n: 'Salmon', t: 'Pez', h: 'Agua', c: 'OmnÃ­voro' }
                ];
                const item = animals[Math.floor(Math.random() * animals.length)];
                const questions = [
                    { q: `Â¿QuÃ© tipo de animal es el/la ${item.n}?`, a: item.t, opts: ['MamÃ­fero', 'Ave', 'Pez', 'Reptil', 'Anfibio'] },
                    { q: `Â¿DÃ³nde vive el/la ${item.n}?`, a: item.h, opts: ['Tierra', 'Agua', 'Aire', 'Agua/Tierra', 'Tierra/Agua'] },
                    { q: `Â¿QuÃ© come el/la ${item.n}?`, a: item.c, opts: ['CarnÃ­voro', 'HerbÃ­voro', 'OmnÃ­voro'] }
                ];
                const q = questions[Math.floor(Math.random() * questions.length)];
                let options = [q.a];
                let allOpts = [...new Set(q.opts.flatMap(o => o.split('/')))];
                while (options.length < 3) {
                    let rand = allOpts[Math.floor(Math.random() * allOpts.length)];
                    if (!options.includes(rand)) options.push(rand);
                }
                
                return { 
                    q: q.q, 
                    a: q.a, 
                    options: options.sort(() => 0.5 - Math.random()),
                    text: q.q,
                    hint: `Piensa en las caracterÃ­sticas del ${item.n}`
                };
            }
        },
        { 
            id: 'animales_invertebrados', 
            name: 'ğŸŒ Animales Invertebrados', 
            type: 'choice', 
            emoji: 'ğŸ¦‹',
            gen: () => {
                const animals = [
                    { n: 'Mariposa', t: 'Insecto' }, { n: 'AraÃ±a', t: 'ArÃ¡cnido' },
                    { n: 'Caracol', t: 'Molusco' }, { n: 'Lombriz', t: 'Gusano' },
                    { n: 'Pulpo', t: 'Molusco' }, { n: 'Abeja', t: 'Insecto' },
                    { n: 'Cangrejo', t: 'CrustÃ¡ceo' }, { n: 'Estrella de mar', t: 'Equinodermo' },
                    { n: 'Hormiga', t: 'Insecto' }, { n: 'Medusa', t: 'Cnidario' }
                ];
                const item = animals[Math.floor(Math.random() * animals.length)];
                
                return { 
                    q: `Â¿QuÃ© tipo de animal invertebrado es el/la ${item.n}?`, 
                    a: item.t, 
                    options: ['Insecto', 'ArÃ¡cnido', 'Molusco', 'Gusano', 'CrustÃ¡ceo', 'Equinodermo', 'Cnidario'].sort(() => 0.5 - Math.random()).slice(0, 4),
                    text: `Clasifica al ${item.n}`,
                    hint: 'Los invertebrados no tienen columna vertebral'
                };
            }
        },
        { 
            id: 'cuerpo_humano', 
            name: 'ğŸ«€ Cuerpo Humano - Ã“rganos', 
            type: 'choice', 
            emoji: 'ğŸ¥',
            gen: () => {
                const organs = [
                    { n: 'CorazÃ³n', f: 'Bombea sangre a todo el cuerpo' },
                    { n: 'Cerebro', f: 'Controla el pensamiento y los movimientos' },
                    { n: 'Pulmones', f: 'Nos permiten respirar' },
                    { n: 'EstÃ³mago', f: 'Digiere los alimentos' },
                    { n: 'HÃ­gado', f: 'Filtra la sangre y produce bilis' },
                    { n: 'RiÃ±ones', f: 'Filtran la sangre y producen orina' },
                    { n: 'Intestinos', f: 'Absorben los nutrientes de la comida' },
                    { n: 'Esqueleto', f: 'Da forma y protecciÃ³n al cuerpo' }
                ];
                const item = organs[Math.floor(Math.random() * organs.length)];
                const others = organs.filter(o => o.n !== item.n).map(o => o.n);
                let options = [item.n, others[0], others[1], others[2]].sort(() => 0.5 - Math.random());
                
                return { 
                    q: `Â¿QuÃ© Ã³rgano tiene esta funciÃ³n? "${item.f}"`, 
                    a: item.n, 
                    options: options,
                    text: 'Adivina el Ã³rgano por su funciÃ³n',
                    hint: 'Piensa en quÃ© parte del cuerpo hace esa funciÃ³n'
                };
            }
        },
        { 
            id: 'sentidos', 
            name: 'ğŸ‘ï¸ Los 5 Sentidos', 
            type: 'choice', 
            emoji: 'ğŸ–ï¸',
            gen: () => {
                const sentidos = [
                    { s: 'Vista', o: 'Ojos', a: 'Ver' },
                    { s: 'OÃ­do', o: 'OÃ­dos', a: 'Escuchar' },
                    { s: 'Olfato', o: 'Nariz', a: 'Oler' },
                    { s: 'Gusto', o: 'Lengua', a: 'Saborear' },
                    { s: 'Tacto', o: 'Piel', a: 'Tocar' }
                ];
                const item = sentidos[Math.floor(Math.random() * sentidos.length)];
                const questions = [
                    { q: `Â¿QuÃ© Ã³rgano usamos para ${item.a.toLowerCase()}?`, a: item.o },
                    { q: `Â¿A quÃ© sentido pertenecen los/las ${item.o}?`, a: item.s },
                    { q: `Con el sentido de la ${item.s.toLowerCase()} podemos...`, a: item.a }
                ];
                const q = questions[Math.floor(Math.random() * questions.length)];
                
                let allAnswers = sentidos.map(s => q.a === s.o ? s.o : q.a === s.s ? s.s : s.a);
                let options = [q.a];
                while (options.length < 4) {
                    let rand = allAnswers[Math.floor(Math.random() * allAnswers.length)];
                    if (!options.includes(rand) && rand !== q.a) options.push(rand);
                }
                
                return { 
                    q: q.q, 
                    a: q.a, 
                    options: options.sort(() => 0.5 - Math.random()),
                    text: q.q,
                    hint: 'Recuerda los 5 sentidos: vista, oÃ­do, olfato, gusto y tacto'
                };
            }
        },
        { 
            id: 'plantas', 
            name: 'ğŸŒ± Las Plantas', 
            type: 'choice', 
            emoji: 'ğŸŒ»',
            gen: () => {
                const parts = [
                    { p: 'RaÃ­z', f: 'Absorbe agua y nutrientes del suelo' },
                    { p: 'Tallo', f: 'Sostiene la planta y transporta savia' },
                    { p: 'Hojas', f: 'Hacen la fotosÃ­ntesis con la luz del sol' },
                    { p: 'Flor', f: 'Es la parte reproductora de la planta' },
                    { p: 'Fruto', f: 'Contiene las semillas' }
                ];
                const item = parts[Math.floor(Math.random() * parts.length)];
                
                return { 
                    q: `Â¿QuÃ© parte de la planta tiene esta funciÃ³n? "${item.f}"`, 
                    a: item.p, 
                    options: ['RaÃ­z', 'Tallo', 'Hojas', 'Flor', 'Fruto'].sort(() => 0.5 - Math.random()),
                    text: 'Identifica la parte de la planta',
                    hint: 'Piensa en quÃ© parte de la planta hace esa funciÃ³n'
                };
            }
        },
        { 
            id: 'geografia_espana', 
            name: 'ğŸ—ºï¸ GeografÃ­a de EspaÃ±a', 
            type: 'choice', 
            emoji: 'ğŸ‡ªğŸ‡¸',
            gen: () => {
                const comunidades = [
                    { n: 'AndalucÃ­a', c: 'Sevilla' }, { n: 'CataluÃ±a', c: 'Barcelona' },
                    { n: 'Madrid', c: 'Madrid' }, { n: 'Valencia', c: 'Valencia' },
                    { n: 'Galicia', c: 'Santiago de Compostela' }, { n: 'PaÃ­s Vasco', c: 'Vitoria' },
                    { n: 'Canarias', c: 'Las Palmas / Santa Cruz' }, { n: 'AragÃ³n', c: 'Zaragoza' },
                    { n: 'Castilla y LeÃ³n', c: 'Valladolid' }, { n: 'Murcia', c: 'Murcia' }
                ];
                const item = comunidades[Math.floor(Math.random() * comunidades.length)];
                const types = [
                    { q: `Â¿CuÃ¡l es la capital de ${item.n}?`, a: item.c },
                    { q: `Â¿En quÃ© comunidad estÃ¡ ${item.c}?`, a: item.n }
                ];
                const q = types[Math.floor(Math.random() * types.length)];
                
                let others = comunidades.filter(c => c.n !== item.n && c.c !== item.c);
                let wrongAnswers = others.slice(0, 3).map(o => q.a === item.c ? o.c : o.n);
                let options = [q.a, ...wrongAnswers].sort(() => 0.5 - Math.random());
                
                return { 
                    q: q.q, 
                    a: q.a, 
                    options: options,
                    text: q.q,
                    hint: 'Recuerda las comunidades autÃ³nomas de EspaÃ±a'
                };
            }
        },
        { 
            id: 'sistema_solar', 
            name: 'ğŸª El Sistema Solar', 
            type: 'choice', 
            emoji: 'ğŸŒ',
            gen: () => {
                const planets = [
                    { n: 'Mercurio', d: 'Es el planeta mÃ¡s cercano al Sol' },
                    { n: 'Venus', d: 'Es el planeta mÃ¡s caliente' },
                    { n: 'Tierra', d: 'Es el Ãºnico planeta con vida conocida' },
                    { n: 'Marte', d: 'Es conocido como el planeta rojo' },
                    { n: 'JÃºpiter', d: 'Es el planeta mÃ¡s grande del sistema solar' },
                    { n: 'Saturno', d: 'Tiene anillos muy visibles' },
                    { n: 'Urano', d: 'Gira de lado respecto a su Ã³rbita' },
                    { n: 'Neptuno', d: 'Es el planeta mÃ¡s lejano del Sol' }
                ];
                const item = planets[Math.floor(Math.random() * planets.length)];
                const questions = [
                    { q: `Â¿QuÃ© planeta es este? "${item.d}"`, a: item.n },
                    { q: `Â¿CuÃ¡l es la caracterÃ­stica principal de ${item.n}?`, a: item.d }
                ];
                const q = questions[Math.floor(Math.random() * questions.length)];
                
                let others = planets.filter(p => p.n !== item.n).map(p => p.n);
                let options = [item.n, others[0], others[1], others[2]].sort(() => 0.5 - Math.random());
                
                return { 
                    q: q.q, 
                    a: q.a, 
                    options: q.a === item.n ? options : planets.map(p => p.d).sort(() => 0.5 - Math.random()).slice(0, 4),
                    text: q.q,
                    hint: 'Recuerda los 8 planetas del sistema solar'
                };
            }
        },
        { 
            id: 'materia_estados', 
            name: 'ğŸ’§ Estados de la Materia', 
            type: 'choice', 
            emoji: 'ğŸ§Š',
            gen: () => {
                const examples = [
                    { e: 'Hielo', s: 'SÃ³lido' }, { e: 'Agua', s: 'LÃ­quido' },
                    { e: 'Vapor', s: 'Gaseoso' }, { e: 'Madera', s: 'SÃ³lido' },
                    { e: 'Leche', s: 'LÃ­quido' }, { e: 'Aire', s: 'Gaseoso' },
                    { e: 'Piedra', s: 'SÃ³lido' }, { e: 'Zumo', s: 'LÃ­quido' },
                    { e: 'Humo', s: 'Gaseoso' }, { e: 'Metal', s: 'SÃ³lido' }
                ];
                const item = examples[Math.floor(Math.random() * examples.length)];
                
                return { 
                    q: `Â¿En quÃ© estado se encuentra: ${item.e}?`, 
                    a: item.s, 
                    options: ['SÃ³lido', 'LÃ­quido', 'Gaseoso'],
                    text: `Identifica el estado de la materia de ${item.e}`,
                    hint: 'SÃ³lido=tiene forma fija, LÃ­quido=se adapta al recipiente, Gaseoso=se expande'
                };
            }
        },
        { 
            id: 'ecosistemas', 
            name: 'ğŸŒ² Ecosistemas', 
            type: 'choice', 
            emoji: 'ğŸï¸',
            gen: () => {
                const ecosistemas = [
                    { n: 'Bosque', d: 'Hay muchos Ã¡rboles y animales como ciervos y lobos' },
                    { n: 'Desierto', d: 'Hace mucho calor y hay poca agua' },
                    { n: 'OcÃ©ano', d: 'Es agua salada y vive mucha vida marina' },
                    { n: 'RÃ­o', d: 'Es agua dulce que fluye hacia el mar' },
                    { n: 'MontaÃ±a', d: 'Es terreno elevado con clima frÃ­o en la cima' },
                    { n: 'Sabana', d: 'Hay hierba alta y animales como leones y elefantes' }
                ];
                const item = ecosistemas[Math.floor(Math.random() * ecosistemas.length)];
                
                return { 
                    q: `Â¿QuÃ© ecosistema es este? "${item.d}"`, 
                    a: item.n, 
                    options: ['Bosque', 'Desierto', 'OcÃ©ano', 'RÃ­o', 'MontaÃ±a', 'Sabana'].sort(() => 0.5 - Math.random()).slice(0, 4),
                    text: 'Identifica el ecosistema por su descripciÃ³n',
                    hint: 'Piensa en las caracterÃ­sticas del lugar'
                };
            }
        }
    ]
};

/* ============================================================================
   LÃ“GICA DEL JUEGO
   ============================================================================ */

let currentSubject = '';
let currentQuestionData = null;
let stars = parseInt(localStorage.getItem('carla_stars')) || 0;
let sessionStars = 0;
let voiceEnabled = true;
let window_activeTopicObj = null;
let consecutiveCorrect = 0;

window.onload = function() {
    updateStats();
    checkMedals();
    document.getElementById('voice-status').innerText = voiceEnabled ? 'ON' : 'OFF';
    setTimeout(() => speak("Bienvenida a la escuela de Carla"), 500);
};

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.speechSynthesis.cancel();
}

function selectSubject(subj) {
    currentSubject = subj;
    const titles = { 'mates': 'ğŸ§® MatemÃ¡ticas', 'lengua': 'ğŸ“– Lengua Castellana', 'medio': 'ğŸŒ Conocimiento del Medio' };
    document.getElementById('subject-title').innerText = titles[subj];
    
    const container = document.getElementById('topics-container');
    container.innerHTML = '';
    
    db[subj].forEach(topic => {
        let btn = document.createElement('button');
        btn.className = 'secondary';
        btn.innerText = topic.name;
        btn.onclick = () => startGame(topic.id);
        container.appendChild(btn);
    });
    
    showScreen('screen-topics');
}

function startGame(topicId) {
    const topic = db[currentSubject].find(t => t.id === topicId);
    window_activeTopicObj = topic;
    sessionStars = 0;
    consecutiveCorrect = 0;
    document.getElementById('session-stars').innerText = sessionStars;
    showScreen('screen-game');
    generateQuestion(topic);
}

function generateQuestion(topic) {
    const data = topic.gen();
    currentQuestionData = data;
    
    // Actualizar UI
    document.getElementById('game-subtitle').innerText = topic.name;
    document.getElementById('emoji-display').innerText = topic.emoji || 'ğŸ“š';
    document.getElementById('question-hint').innerText = data.hint || '';
    
    // Manejar HTML en preguntas (fracciones)
    if (data.isFraction) {
        document.getElementById('question-text').innerHTML = data.q;
    } else {
        document.getElementById('question-text').innerText = data.q;
    }
    
    // Actualizar barra de progreso
    let progress = Math.min((sessionStars / 10) * 100, 100);
    document.getElementById('progress-bar').style.width = progress + '%';
    
    const answerArea = document.getElementById('answer-area');
    answerArea.innerHTML = '';
    document.getElementById('btn-check').style.display = 'none';

    if (topic.type === 'input') {
        let input = document.createElement('input');
        input.type = currentSubject === 'mates' && !data.isFraction ? 'number' : 'text';
        input.id = 'user-answer';
        input.placeholder = '?';
        input.autocomplete = 'off';
        input.inputmode = currentSubject === 'mates' && !data.isFraction ? 'numeric' : 'text';
        answerArea.appendChild(input);
        
        let btn = document.getElementById('btn-check');
        btn.style.display = 'inline-block';
        setTimeout(() => { input.focus(); }, 500);
    } else if (topic.type === 'choice') {
        let grid = document.createElement('div');
        grid.className = 'options-grid';
        grid.style.gridTemplateColumns = data.options.length > 2 ? '1fr 1fr' : '1fr';
        
        let opts = data.options || [];
        if(opts.length === 0) opts = ['OpciÃ³n A', 'OpciÃ³n B'];

        opts.forEach(opt => {
            let btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkChoice(btn, opt);
            grid.appendChild(btn);
        });
        answerArea.appendChild(grid);
    }

    if (voiceEnabled) speak(data.text);
}

function checkChoice(btnElement, selectedValue) {
    let allBtns = document.querySelectorAll('.option-btn');
    allBtns.forEach(b => b.disabled = true);

    if (selectedValue == currentQuestionData.a) {
        btnElement.classList.add('correct');
        handleSuccess();
    } else {
        btnElement.classList.add('wrong');
        allBtns.forEach(b => {
            if(b.innerText == currentQuestionData.a) b.classList.add('correct');
        });
        handleFail();
    }
}

function checkAnswer() {
    let input = document.getElementById('user-answer');
    let val = input.value.trim();
    
    if (!val) return;
    
    if (currentQuestionData.isFraction) {
        // Comparar fracciones como texto
        if (val.replace(/\s/g, '') === currentQuestionData.a.replace(/\s/g, '')) {
            handleSuccess();
        } else {
            handleFail();
            input.value = '';
            input.focus();
        }
    } else if (currentSubject !== 'mates') {
        val = val.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        let correct = currentQuestionData.a.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        if (val === correct) {
            handleSuccess();
        } else {
            handleFail();
            input.value = '';
            input.focus();
        }
    } else {
        if (parseInt(val) === currentQuestionData.a) {
            handleSuccess();
        } else {
            handleFail();
            input.value = '';
            input.focus();
        }
    }
}

function handleSuccess() {
    consecutiveCorrect++;
    let bonusStars = consecutiveCorrect >= 5 ? 2 : 1;
    
    if (voiceEnabled) {
        const praises = ["Â¡Muy bien!", "Â¡Excelente!", "Â¡Eres genial!", "Â¡FantÃ¡stico!", "Â¡Sigue asÃ­!"];
        speak(praises[Math.floor(Math.random() * praises.length)]);
    }
    
    addStar(bonusStars);
    sessionStars += bonusStars;
    document.getElementById('session-stars').innerText = sessionStars;
    
    setTimeout(() => {
        generateQuestion(window_activeTopicObj); 
    }, 1500);
}

function handleFail() {
    consecutiveCorrect = 0;
    if (voiceEnabled) {
        const encourages = ["IntÃ©ntalo de nuevo", "TÃº puedes", "Casi lo tienes", "Sigue practicando"];
        speak(encourages[Math.floor(Math.random() * encourages.length)]);
    }
    document.body.style.backgroundColor = "#ffcccc";
    setTimeout(() => { document.body.style.backgroundColor = "var(--secondary)"; }, 300);
}

function addStar(amount = 1) {
    stars += amount;
    localStorage.setItem('carla_stars', stars);
    updateStats();
    checkMedals();
    
    document.body.style.backgroundColor = "#ffeaa7";
    setTimeout(() => { document.body.style.backgroundColor = "var(--secondary)"; }, 300);
}

function updateStats() {
    document.getElementById('total-stars').innerText = stars;
    let level = "Novata";
    if(stars > 20) level = "Aprendiz";
    if(stars > 50) level = "Experta";
    if(stars > 150) level = "Maestra";
    if(stars > 300) level = "Genio";
    if(stars > 600) level = "Legendaria";
    if(stars > 1000) level = "Inmortal";
    document.getElementById('user-level').innerText = level;
}

function checkMedals() {
    const medals = [
        { id: 'medal-1', req: 10 },
        { id: 'medal-2', req: 50 },
        { id: 'medal-3', req: 100 },
        { id: 'medal-4', req: 300 },
        { id: 'medal-5', req: 600 },
        { id: 'medal-6', req: 1000 },
        { id: 'medal-7', req: 2000 },
        { id: 'medal-8', req: 5000 }
    ];
    medals.forEach(m => {
        if(stars >= m.req) document.getElementById(m.id).classList.add('unlocked');
        else document.getElementById(m.id).classList.remove('unlocked');
    });
}

function resetProgress() {
    if(confirm("âš ï¸ Â¿Seguro que quieres BORRAR TODO el progreso? Esto no se puede deshacer.")) {
        stars = 0;
        localStorage.setItem('carla_stars', 0);
        updateStats();
        checkMedals();
        alert("Progreso reiniciado.");
        showScreen('screen-home');
    }
}

function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    document.getElementById('voice-status').innerText = voiceEnabled ? 'ON' : 'OFF';
    if(voiceEnabled) speak("Voz activada");
}

function speak(text) {
    if (!voiceEnabled) return;
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-ES';
        utterance.rate = 0.95;
        utterance.pitch = 1.1;
        window.speechSynthesis.speak(utterance);
    }
}

function speakCurrentText() {
    if(currentQuestionData && voiceEnabled) speak(currentQuestionData.text);
}

// Permitir Enter para enviar respuesta
document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.getElementById('btn-check').style.display !== 'none') {
        checkAnswer();
    }
});
</script>
</body>
</html>