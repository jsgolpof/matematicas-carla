<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escuela Carla - Master Class üéì</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --success: #2ecc71;
            --error: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --font-main: 'Segoe UI', 'Comic Sans MS', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, #4ECDC4 0%, #556270 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* HEADER & STATS */
        .header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            box-sizing: border-box;
        }
        .level-badge {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* CARDS & BUTTONS */
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            animation: slideUp 0.5s ease;
            box-sizing: border-box;
        }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        h1 { color: var(--dark); margin-top: 0; }
        h2 { color: var(--secondary); }

        button {
            background: white;
            border: 2px solid var(--secondary);
            color: var(--dark);
            padding: 15px;
            width: 100%;
            margin: 8px 0;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-main);
            box-shadow: 0 4px 0 #bdc3c7;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button.primary { background: var(--primary); color: white; border-color: #c0392b; box-shadow: 0 4px 0 #c0392b; }
        button.secondary { background: var(--secondary); color: white; border-color: #16a085; box-shadow: 0 4px 0 #16a085; }
        
        /* GAME SPECIFIC */
        .question-area { font-size: 1.4rem; margin: 20px 0; line-height: 1.5; font-weight: 600; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        
        .option-btn {
            background: #f8f9fa;
            border: 2px solid #ddd;
            box-shadow: 0 4px 0 #ccc;
            font-size: 1rem;
        }
        .option-btn:hover { background: #e9ecef; }
        
        .option-btn.correct {
            background: var(--success) !important;
            color: white !important;
            border-color: #27ae60 !important;
            box-shadow: 0 4px 0 #219150 !important;
            animation: pulse 0.5s;
        }
        .option-btn.wrong {
            background: var(--error) !important;
            color: white !important;
            border-color: #c0392b !important;
            box-shadow: 0 4px 0 #c0392b !important;
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* FEEDBACK MODAL */
        .feedback-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }
        .feedback-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .feedback-title { font-size: 2.5rem; margin: 0 0 15px 0; font-weight: 900; }
        .feedback-correct { color: var(--success); }
        .feedback-explanation { 
            background: #e8f6f3; 
            border-left: 5px solid var(--secondary); 
            padding: 15px; 
            text-align: left; 
            margin: 20px 0; 
            border-radius: 5px;
            font-size: 1.1rem;
            line-height: 1.4;
        }
        .feedback-icon { font-size: 4rem; display: block; margin-bottom: 10px; }

        /* INPUTS */
        input[type="number"], input[type="text"] {
            width: 80%;
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            border: 3px solid var(--secondary);
            border-radius: 10px;
            margin: 10px 0;
            font-family: var(--font-main);
        }

        /* SCREENS */
        .screen { display: none; width: 100%; }
        .active { display: block; }

        .progress-container {
            width: 100%;
            background: #eee;
            height: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.5s;
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- HEADER GLOBAL -->
    <div class="header">
        <div>‚≠ê <span id="total-stars">0</span></div>
        <div class="level-badge">Nivel: <span id="current-level">1</span></div>
        <div onclick="goHome()" style="cursor:pointer; font-size:1.5rem;">üè†</div>
    </div>

    <!-- PANTALLA INICIO -->
    <div id="screen-home" class="screen active">
        <div class="card">
            <h1>¬°Hola Carla! üéì</h1>
            <p>Elige qu√© quieres aprender hoy.</p>
            <div style="font-size: 4rem; margin: 20px;">üöÄ</div>
            <button class="primary" onclick="selectSubject('mates')">üßÆ Matem√°ticas</button>
            <button class="secondary" onclick="selectSubject('lengua')">üìñ Lengua</button>
            <button style="background:#1dd1a1; color:white; border:none;" onclick="selectSubject('medio')">üåç Conocimiento del Medio</button>
        </div>
    </div>

    <!-- PANTALLA TEMAS -->
    <div id="screen-topics" class="screen">
        <div class="card">
            <h2 id="topic-title">Temas</h2>
            <div id="topics-list"></div>
            <button onclick="goHome()" style="margin-top:20px; background:#95a5a6; color:white; border:none;">Volver</button>
        </div>
    </div>

    <!-- PANTALLA JUEGO -->
    <div id="screen-game" class="screen">
        <div class="progress-container"><div class="progress-bar" id="game-progress"></div></div>
        
        <div class="card">
            <div id="question-emoji" style="font-size: 3rem; margin-bottom: 10px;">‚ùì</div>
            <div id="question-text" class="question-area">Pregunta...</div>
            
            <div id="input-area"></div>
            <div id="options-area" class="options-grid"></div>
            
            <button id="btn-submit" class="primary" onclick="checkInputAnswer()" style="margin-top:20px; display:none;">Comprobar</button>
        </div>
    </div>

</div>

<!-- MODAL DE FEEDBACK -->
<div id="feedback-modal" class="feedback-overlay">
    <div class="feedback-card">
        <span id="fb-icon" class="feedback-icon">üéâ</span>
        <h2 id="fb-title" class="feedback-title">¬°Correcto!</h2>
        <div id="fb-content"></div>
        <button class="primary" onclick="nextQuestion()" style="margin-top:20px;">Siguiente ‚û°Ô∏è</button>
    </div>
</div>

<script>
/* ============================================================================
   BASE DE DATOS DE CONOCIMIENTO (RICA Y EXPLICATIVA)
   ============================================================================ */

const knowledgeDB = {
    lengua: {
        ortografia: [
            {
                q: "¬øC√≥mo se escribe: __arco?",
                options: ["B", "V"],
                correct: "B",
                explanation: "Se escribe con <b>B</b> porque las palabras que empiezan por 'bar-' suelen llevar B (barco, barba, barrio)."
            },
            {
                q: "¬øC√≥mo se escribe: __aca?",
                options: ["B", "V"],
                correct: "V",
                explanation: "Se escribe con <b>V</b>. Recuerda: 'La Vaca tiene cuernos en forma de V'."
            },
            {
                q: "¬øQu√© palabra est√° bien escrita?",
                options: ["Girafa", "Jirafa"],
                correct: "Jirafa",
                explanation: "Se escribe con <b>J</b>. Las palabras que empiezan por 'jira-' llevan J."
            },
            {
                q: "¬øQu√© palabra est√° bien escrita?",
                options: ["Gato", "Jato"],
                correct: "Gato",
                explanation: "Se escribe con <b>G</b>. Los sonidos suaves de 'ga, go, gu' suelen ir con G."
            },
            {
                q: "¬øLleva H la palabra '__uevo'?",
                options: ["S√≠, lleva H", "No, no lleva H"],
                correct: "S√≠, lleva H",
                explanation: "¬°S√≠! Las palabras que empiezan por 'hue-' y 'hie-' siempre llevan H muda (huevo, hielo, hierba)."
            },
            {
                q: "Elige la correcta:",
                options: ["Hombre", "Ombre"],
                correct: "Hombre",
                explanation: "Lleva <b>H</b> inicial. Proviene del lat√≠n 'homo'."
            },
            {
                q: "¬øC√≥mo se pluraliza 'L√°piz'?",
                options: ["L√°pizes", "L√°pices"],
                correct: "L√°pices",
                explanation: "Las palabras terminadas en -Z cambian la Z por C en plural (L√°piz -> L√°pices, Pez -> Peces)."
            },
            {
                q: "¬øQu√© palabra es un VERBO?",
                options: ["Casa", "Correr", "Rojo"],
                correct: "Correr",
                explanation: "'Correr' es una acci√≥n, por eso es un verbo. 'Casa' es un lugar (sustantivo) y 'Rojo' es un color (adjetivo)."
            },
            {
                q: "Sin√≥nimo de 'Feliz':",
                options: ["Triste", "Contento", "Enfadado"],
                correct: "Contento",
                explanation: "Un sin√≥nimo es una palabra que significa lo mismo. Si est√°s feliz, est√°s contento."
            },
            {
                q: "Ant√≥nimo de 'D√≠a':",
                options: ["Sol", "Noche", "Luz"],
                correct: "Noche",
                explanation: "Un ant√≥nimo es lo contrario. Lo contrario del D√≠a es la Noche."
            },
            {
                q: "¬øQu√© palabra es AGUDA?",
                options: ["Cami√≥n", "L√°piz", "√Årbol"],
                correct: "Cami√≥n",
                explanation: "Las palabras agudas tienen la fuerza de voz en la √∫ltima s√≠laba. Cami√≥n lleva tilde porque termina en N."
            },
            {
                q: "Completa: 'El ___ es azul'.",
                options: ["cielo", "suelo", "pelo"],
                correct: "cielo",
                explanation: "El cielo es el espacio sobre la tierra, y normalmente lo vemos azul."
            }
        ],
        gramatica: [
            {
                q: "¬øCu√°l es el sustantivo en: 'El perro ladra'?",
                options: ["El", "Perro", "Ladra"],
                correct: "Perro",
                explanation: "El sustantivo es la palabra que nombra a seres u objetos. Aqu√≠ nombra al animal."
            },
            {
                q: "¬øCu√°l es el adjetivo en: 'La casa roja'?",
                options: ["Casa", "La", "Roja"],
                correct: "Roja",
                explanation: "El adjetivo dice c√≥mo es el sustantivo. 'Roja' nos dice c√≥mo es la casa."
            },
            {
                q: "¬øQu√© tiempo verbal es 'Com√≠'?",
                options: ["Presente", "Pasado", "Futuro"],
                correct: "Pasado",
                explanation: "'Com√≠' indica una acci√≥n que ya termin√≥. Es Pret√©rito Perfecto Simple."
            }
        ]
    },
    medio: {
        animales: [
            {
                q: "¬øQu√© tipo de animal es la ballena?",
                options: ["Pez", "Mam√≠fero", "Reptil"],
                correct: "Mam√≠fero",
                explanation: "Aunque vive en el agua, la ballena es mam√≠fero porque respira por pulmones, tiene sangre caliente y da de mamar a sus cr√≠as."
            },
            {
                q: "¬øQu√© animal es un invertebrado?",
                options: ["Perro", "Mariposa", "√Åguila"],
                correct: "Mariposa",
                explanation: "La mariposa es un insecto y no tiene columna vertebral (huesos internos), por eso es invertebrado."
            },
            {
                q: "¬øQu√© comen los animales herb√≠voros?",
                options: ["Carne", "Plantas", "Todo"],
                correct: "Plantas",
                explanation: "Herb√≠voro viene de 'hierba'. Se alimentan exclusivamente de vegetales."
            },
            {
                q: "¬øC√≥mo respiran los peces?",
                options: ["Por pulmones", "Por branquias", "Por la piel"],
                correct: "Por branquias",
                explanation: "Las branquias filtran el ox√≠geno que hay disuelto en el agua."
            },
            {
                q: "¬øQu√© animal es ov√≠paro?",
                options: ["Gato", "Gallina", "Vaca"],
                correct: "Gallina",
                explanation: "Ov√≠paro significa que nace de un huevo. La gallina pone huevos."
            }
        ],
        cuerpo: [
            {
                q: "¬øQu√© √≥rgano bombea la sangre?",
                options: ["Cerebro", "Coraz√≥n", "Est√≥mago"],
                correct: "Coraz√≥n",
                explanation: "El coraz√≥n es un m√∫sculo que funciona como una bomba para enviar sangre a todo el cuerpo."
            },
            {
                q: "¬øD√≥nde se digiere la comida?",
                options: ["En el Est√≥mago", "En el Cerebro", "En los Pulmones"],
                correct: "En el Est√≥mago",
                explanation: "El est√≥mago es como una batidora que mezcla la comida con jugos g√°stricos."
            },
            {
                q: "¬øQu√© hueso protege el cerebro?",
                options: ["Las Costillas", "El Cr√°neo", "La Pelvis"],
                correct: "El Cr√°neo",
                explanation: "El cr√°neo es un hueso muy duro en forma de casco que protege nuestra parte m√°s importante."
            }
        ],
        planeta: [
            {
                q: "¬øCu√°l es el planeta m√°s grande?",
                options: ["Tierra", "Marte", "J√∫piter"],
                correct: "J√∫piter",
                explanation: "J√∫piter es tan grande que dentro cabr√≠an 1.300 Tierras."
            },
            {
                q: "¬øQu√© planeta tiene anillos visibles?",
                options: ["Saturno", "Venus", "Mercurio"],
                correct: "Saturno",
                explanation: "Saturno tiene un sistema de anillos formado por hielo y rocas muy brillante."
            },
            {
                q: "¬øEn qu√© planeta vivimos?",
                options: ["Marte", "Tierra", "Luna"],
                correct: "Tierra",
                explanation: "La Tierra es el √∫nico planeta conocido con agua l√≠quida y vida."
            },
            {
                q: "¬øQu√© movimiento causa el D√≠a y la Noche?",
                options: ["Traslaci√≥n", "Rotaci√≥n", "√ìrbita"],
                correct: "Rotaci√≥n",
                explanation: "La Rotaci√≥n es cuando la Tierra gira sobre s√≠ misma como una peonza (tarda 24 horas)."
            }
        ]
    }
};

/* ============================================================================
   MOTOR MATEM√ÅTICO INTELIGENTE
   ============================================================================ */
const mathEngine = {
    level: 1,
    generate: function(topic) {
        // Ajustar dificultad seg√∫n nivel (1 a 5)
        let n1, n2, n3, res, text, hint;
        const l = this.level;

        if (topic === 'sumas') {
            if (l < 3) { n1 = r(10, 50); n2 = r(10, 50); }
            else if (l < 5) { n1 = r(100, 500); n2 = r(100, 500); }
            else { n1 = r(500, 1000); n2 = r(500, 1000); }
            return { type: 'input', q: `${n1} + ${n2}`, a: n1 + n2, hint: 'Suma las unidades, luego las decenas...' };
        }
        if (topic === 'restas') {
            if (l < 3) { n1 = r(50, 90); n2 = r(10, 40); }
            else { n1 = r(200, 900); n2 = r(50, n1-10); }
            return { type: 'input', q: `${n1} - ${n2}`, a: n1 - n2, hint: 'Recuerda llevar si la cifra de arriba es menor.' };
        }
        if (topic === 'mult') {
            if (l < 3) { n1 = r(2, 5); n2 = r(2, 9); }
            else { n1 = r(6, 9); n2 = r(6, 12); }
            return { type: 'input', q: `${n1} √ó ${n2}`, a: n1 * n2, hint: 'Usa las tablas de multiplicar.' };
        }
        if (topic === 'div') {
            if (l < 3) { n2 = r(2, 5); res = r(2, 9); }
            else { n2 = r(6, 9); res = r(10, 20); }
            n1 = n2 * res;
            return { type: 'input', q: `${n1} : ${n2}`, a: res, hint: 'Piensa: ¬øQu√© n√∫mero por ' + n2 + ' da ' + n1 + '?' };
        }
        if (topic === 'fraccion') {
            let den = [2,3,4,5,10][r(0,4)];
            let num1 = r(1, den-1);
            let num2 = r(1, den-num1);
            return { 
                type: 'input', 
                q: `<span style='display:inline-block; text-align:center'><span style='border-bottom:2px solid black'>${num1}</span><br>${den}</span> + <span style='display:inline-block; text-align:center'><span style='border-bottom:2px solid black'>${num2}</span><br>${den}</span>`, 
                a: `${num1+num2}/${den}`, 
                hint: 'Suma los de arriba (numeradores) y deja los de abajo igual.' 
            };
        }
        if (topic === 'problema') {
            // Problemas compuestos din√°micos
            if (l < 3) {
                // 1 Operaci√≥n
                n1 = r(10, 50); n2 = r(5, 20);
                const ops = [
                    { t: `Tengo ${n1} cromos y compro ${n2}.`, a: n1+n2, op: '+' },
                    { t: `Hay ${n1} p√°jaros y se van ${n2}.`, a: n1-n2, op: '-' }
                ];
                const p = ops[r(0,1)];
                return { type: 'input', q: p.t + " ¬øCu√°ntos hay?", a: p.a, hint: p.op === '+' ? 'Suma' : 'Resta' };
            } else {
                // 2 Operaciones (Compuestos)
                n1 = r(20, 100); n2 = r(5, 20); n3 = r(5, 10);
                const probs = [
                    { t: `Carla tiene ${n1}‚Ç¨. Gasta ${n2}‚Ç¨ y luego su abuela le da ${n3}‚Ç¨.`, a: (n1-n2)+n3, hint: 'Primero resta lo que gasta, luego suma lo que le dan.' },
                    { t: `En un bus van ${n1} personas. Bajan ${n2} y suben ${n3}.`, a: (n1-n2)+n3, hint: 'Sigue el orden de la historia.' }
                ];
                const p = probs[r(0,1)];
                return { type: 'input', q: p.t + " ¬øCu√°ntas hay ahora?", a: p.a, hint: p.hint };
            }
        }
    }
};

/* ============================================================================
   L√ìGICA DE LA APP
   ============================================================================ */

let state = {
    stars: parseInt(localStorage.getItem('carla_stars_v4')) || 0,
    level: parseInt(localStorage.getItem('carla_level_v4')) || 1,
    subject: '',
    topic: '',
    currentQ: null,
    streak: 0, // Racha de aciertos
    attempts: 0 // Intentos en la pregunta actual
};

// Utilidad random
function r(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function init() {
    updateStats();
    // Ajustar nivel del motor matem√°tico
    mathEngine.level = state.level;
}

function updateStats() {
    document.getElementById('total-stars').innerText = state.stars;
    document.getElementById('current-level').innerText = state.level;
    localStorage.setItem('carla_stars_v4', state.stars);
    localStorage.setItem('carla_level_v4', state.level);
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function goHome() {
    showScreen('screen-home');
}

function selectSubject(subj) {
    state.subject = subj;
    const titles = { 'mates': 'Matem√°ticas', 'lengua': 'Lengua', 'medio': 'Conocimiento del Medio' };
    document.getElementById('topic-title').innerText = titles[subj];
    
    const list = document.getElementById('topics-list');
    list.innerHTML = '';
    
    let topics = [];
    if (subj === 'mates') topics = [
        {id:'sumas', name:'Sumas'}, {id:'restas', name:'Restas'}, 
        {id:'mult', name:'Multiplicaci√≥n'}, {id:'div', name:'Divisiones'},
        {id:'fraccion', name:'Fracciones'}, {id:'problema', name:'Problemas'}
    ];
    if (subj === 'lengua') topics = [
        {id:'ortografia', name:'Ortograf√≠a'}, {id:'gramatica', name:'Gram√°tica'}
    ];
    if (subj === 'medio') topics = [
        {id:'animales', name:'Animales'}, {id:'cuerpo', name:'Cuerpo Humano'}, {id:'planeta', name:'El Universo'}
    ];

    topics.forEach(t => {
        let btn = document.createElement('button');
        btn.className = 'secondary';
        btn.innerText = t.name;
        btn.onclick = () => startGame(t.id);
        list.appendChild(btn);
    });
    
    showScreen('screen-topics');
}

function startGame(topicId) {
    state.topic = topicId;
    state.attempts = 0;
    showScreen('screen-game');
    loadQuestion();
}

function loadQuestion() {
    state.attempts = 0;
    document.getElementById('game-progress').style.width = '0%';
    const areaOpt = document.getElementById('options-area');
    const areaInp = document.getElementById('input-area');
    const btnSub = document.getElementById('btn-submit');
    
    areaOpt.innerHTML = '';
    areaInp.innerHTML = '';
    btnSub.style.display = 'none';

    // Generar Pregunta
    if (state.subject === 'mates') {
        state.currentQ = mathEngine.generate(state.topic);
        document.getElementById('question-emoji').innerText = 'üßÆ';
    } else {
        // Elegir banco de conocimiento
        const bank = knowledgeDB[state.subject][state.topic];
        // Filtrar por nivel si fuera necesario (aqu√≠ simplificado aleatorio)
        state.currentQ = bank[r(0, bank.length - 1)];
        document.getElementById('question-emoji').innerText = state.subject === 'lengua' ? 'üìñ' : 'üåç';
    }

    // Renderizar
    document.getElementById('question-text').innerHTML = state.currentQ.q;

    if (state.currentQ.type === 'input' || !state.currentQ.options) {
        // Input num√©rico o texto
        let inp = document.createElement('input');
        inp.type = state.subject === 'mates' && state.topic !== 'fraccion' ? 'number' : 'text';
        inp.id = 'user-input';
        inp.placeholder = 'Escribe tu respuesta...';
        inp.onkeypress = (e) => { if(e.key==='Enter') checkInputAnswer(); };
        areaInp.appendChild(inp);
        btnSub.style.display = 'inline-block';
        setTimeout(() => inp.focus(), 500);
    } else {
        // Opciones m√∫ltiples
        state.currentQ.options.forEach(opt => {
            let btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkOptionAnswer(btn, opt);
            areaOpt.appendChild(btn);
        });
    }
}

function checkInputAnswer() {
    let val = document.getElementById('user-input').value.trim();
    if (!val) return;
    
    // Normalizar para mates
    if (state.subject === 'mates') {
        if (state.topic === 'fraccion') {
             // Comparaci√≥n simple de strings para fracciones
             if (val.replace(/\s/g,'') === state.currentQ.a.replace(/\s/g,'')) handleSuccess();
             else handleFail();
        } else {
            if (parseInt(val) === state.currentQ.a) handleSuccess();
            else handleFail();
        }
    } else {
        // Lengua (texto)
        if (val.toLowerCase() === state.currentQ.a.toLowerCase()) handleSuccess();
        else handleFail();
    }
}

function checkOptionAnswer(btnElement, selectedValue) {
    // Si ya est√° marcada como correcta o wrong, ignorar
    if (btnElement.classList.contains('correct') || btnElement.classList.contains('wrong')) return;

    state.attempts++;
    
    if (selectedValue === state.currentQ.correct) {
        btnElement.classList.add('correct');
        handleSuccess();
    } else {
        btnElement.classList.add('wrong');
        // NO bloqueamos el juego, solo este bot√≥n. El usuario puede elegir otro.
        // Pero registramos el fallo para no dar estrella completa si es el 2¬∫ intento
        handleFail(false); 
    }
}

function handleSuccess() {
    // Calcular recompensa
    let starsGain = 1;
    if (state.attempts === 0) starsGain = 2; // Primera intento = bonus
    
    state.stars += starsGain;
    state.streak++;
    
    // Subir nivel cada 5 aciertos seguidos
    if (state.streak % 5 === 0) {
        state.level++;
        mathEngine.level = state.level;
        alert("¬°Nivel Subido! Ahora eres Nivel " + state.level);
    }
    
    updateStats();
    showFeedback(true);
}

function handleFail(isFinal = false) {
    state.streak = 0;
    // Si es input y falla, limpiamos para reintentar
    if (state.currentQ.type === 'input' || !state.currentQ.options) {
        document.getElementById('user-input').value = '';
        document.getElementById('user-input').focus();
    }
    // Si es opci√≥n m√∫ltiple, ya se marc√≥ en rojo en checkOptionAnswer
}

function showFeedback(isCorrect) {
    const modal = document.getElementById('feedback-modal');
    const title = document.getElementById('fb-title');
    const content = document.getElementById('fb-content');
    const icon = document.getElementById('fb-icon');
    
    modal.style.display = 'flex';
    
    if (isCorrect) {
        title.innerText = state.attempts === 0 ? "¬°Excelente!" : "¬°Correcto!";
        title.className = "feedback-title feedback-correct";
        icon.innerText = "üéâ";
        
        let html = "";
        // Si es Lengua o Medio, mostrar explicaci√≥n
        if (state.subject !== 'mates' && state.currentQ.explanation) {
            html = `<div class="feedback-explanation"><b>üí° ¬øSab√≠as qu√©?</b><br>${state.currentQ.explanation}</div>`;
        } else if (state.subject === 'mates') {
            html = `<div class="feedback-explanation">Operaci√≥n resuelta correctamente. ¬°Sigue as√≠!</div>`;
        } else {
            html = "<div class='feedback-explanation'>¬°Muy bien hecho!</div>";
        }
        content.innerHTML = html;
    } else {
        // Caso de fallo final (si implement√°ramos game over)
    }
}

function nextQuestion() {
    document.getElementById('feedback-modal').style.display = 'none';
    loadQuestion();
}

// Iniciar
init();

</script>
</body>
</html>
